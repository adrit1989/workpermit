<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IndianOil Permit System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU"></script>
    <style>
      body { background: #f3f4f6; color: #1f2937; font-family: 'Segoe UI', sans-serif; font-size: 0.85rem; }
      .glass-panel { background: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; }
      input, select, textarea { width: 100%; border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.375rem; font-size: 0.85rem; transition: border-color 0.15s; }
      input:focus, select:focus, textarea:focus { outline: none; border-color: #f97316; ring: 2px solid #f97316; }
      input:disabled, select:disabled, textarea:disabled { background-color: #f9fafb; color: #6b7280; cursor: not-allowed; }
      .header-bar { background: #f97316; color: white; padding: 1rem; font-weight: bold; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      table.checklist-table { width: 100%; border-collapse: collapse; }
      table.checklist-table th { background: #fef3c7; text-align: left; padding: 8px; border: 1px solid #e5e7eb; font-weight: 600; color: #92400e; }
      table.checklist-table td { border: 1px solid #e5e7eb; padding: 6px 8px; vertical-align: middle; }
    </style>
  </head>
  <body class="bg-gray-100">

    <div id="view-login" class="flex items-center justify-center min-h-screen">
      <div class="glass-panel w-96 shadow-xl">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-orange-600">IndianOil</h1>
            <p class="text-gray-500 text-xs">Work Permit System (OISD-105)</p>
        </div>
        <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
          <select id="login-role" class="w-full"><option>Loading...</option></select>
          <select id="login-name" class="w-full" disabled><option>Select Role First</option></select>
          <input type="password" id="login-password" placeholder="Password (default: p123)" class="w-full">
          <button class="w-full bg-orange-600 text-white py-2 rounded font-bold hover:bg-orange-700 transition">Sign In</button>
        </form>
      </div>
    </div>

    <div id="app-container" style="display: none;">
      <nav class="header-bar fixed w-full z-50 top-0">
        <div class="flex items-center gap-3">
             <span>üõ°Ô∏è IndianOil WPS</span>
        </div>
        <div class="flex items-center gap-4 text-sm font-normal">
          <div class="text-right"><span id="user-info" class="font-bold"></span><br><span id="user-role-badge" class="opacity-80"></span></div>
          <button onclick="location.reload()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded">Logout</button>
        </div>
      </nav>
      
      <main class="max-w-7xl mx-auto px-4 pt-20 pb-12">
        
        <div id="view-dashboard">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
            <div class="flex gap-2">
                <button onclick="showAddUser()" class="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 text-xs font-bold" id="btn-add-user">Users</button>
                <button onclick="showMap()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 text-xs font-bold" id="btn-view-map">Map</button>
                <button onclick="window.open('/api/download-excel')" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 text-xs font-bold" id="btn-download-excel">Excel</button>
                <button onclick="showNewPermit()" class="bg-orange-600 text-white px-4 py-2 rounded shadow hover:bg-orange-700 text-xs font-bold" id="btn-new-permit">+ New Permit</button>
            </div>
          </div>
          
          <div class="glass-panel overflow-x-auto">
             <table class="w-full text-sm text-left border-collapse">
                 <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                     <tr><th class="p-3">ID</th><th>Work Type</th><th>Location</th><th>Requester</th><th>Status</th><th>Action</th></tr>
                 </thead>
                 <tbody id="permit-list-body" class="divide-y divide-gray-200"></tbody>
             </table>
          </div>
        </div>

        <div id="view-form" class="hidden">
           <div class="flex justify-between items-center mb-4">
               <button onclick="showDashboard()" class="text-gray-600 hover:text-gray-900 font-bold">‚Üê Back to Dashboard</button>
               <div id="permit-header-display" class="px-4 py-2 bg-orange-100 text-orange-800 rounded border border-orange-200 font-bold text-sm"></div>
           </div>

           <form id="permit-form" class="space-y-6">
              <input type="hidden" id="PermitID" name="PermitID"><input type="hidden" id="Status" name="Status">
              
              <div class="glass-panel">
                 <h3 class="font-bold text-lg text-gray-800 mb-4 border-b pb-2">1. Main Permit Details</h3>
                 <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div><label class="block text-xs text-gray-500 mb-1">Work Type</label><select id="WorkType" name="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option><option>Vehicle Entry</option></select></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Specific Work</label><input id="WorkTypeOther" name="WorkTypeOther"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Requester</label><input id="RequesterName" name="RequesterName" readonly></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Official Name</label><input id="OfficialName" name="OfficialName" readonly></div>
                    
                    <div class="col-span-1 md:col-span-2"><label class="block text-xs text-gray-500 mb-1">Location / Chainage</label><input id="ExactLocation" name="ExactLocation"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Unit/Section</label><input id="LocationUnit" name="LocationUnit" value="Pipeline"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Issued To Dept</label><input id="IssuedToDept" name="IssuedToDept"></div>
                    
                    <div class="col-span-full"><label class="block text-xs text-gray-500 mb-1">Description of Work</label><textarea id="Desc" name="Desc" rows="2"></textarea></div>

                    <div><label class="block text-xs text-gray-500 mb-1">Vendor Name</label><input id="Vendor" name="Vendor"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Security Guard</label><input id="SecurityGuard" name="SecurityGuard"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Emergency Contact</label><input id="EmergencyContact" name="EmergencyContact"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Nearest Fire Stn</label><input id="FireStation" name="FireStation"></div>

                    <div><label class="block text-xs text-gray-500 mb-1">Valid From</label><input type="datetime-local" id="ValidFrom" name="ValidFrom"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Valid To</label><input type="datetime-local" id="ValidTo" name="ValidTo"></div>
                    
                    <div class="col-span-1 md:col-span-2 p-2 bg-gray-50 rounded border flex gap-2 items-end">
                        <div class="flex-1"><label class="text-xs">Latitude</label><input id="Latitude" name="Latitude"></div>
                        <div class="flex-1"><label class="text-xs">Longitude</label><input id="Longitude" name="Longitude"></div>
                        <button type="button" onclick="getGeo()" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">üìç</button>
                    </div>

                    <div><label class="block text-xs text-gray-500 mb-1">Assign Reviewer</label><select id="ReviewerEmail" name="ReviewerEmail"></select></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Assign Approver</label><select id="ApproverEmail" name="ApproverEmail"></select></div>
                 </div>
              </div>

              <div class="glass-panel">
                  <h3 class="font-bold text-lg text-gray-800 mb-4 border-b pb-2">2. Safety Checklists</h3>
                  
                  <h4 class="font-bold text-orange-600 mt-4 mb-2 text-sm uppercase">Section A: General Checks</h4>
                  <table class="checklist-table">
                      <thead><tr><th class="w-1/2">Check Point</th><th>Status</th><th>Remarks</th></tr></thead>
                      <tbody id="checklist-container"></tbody>
                  </table>

                  <h4 class="font-bold text-orange-600 mt-6 mb-2 text-sm uppercase">Section B/C/D: Specific Checks</h4>
                  <table class="checklist-table">
                      <thead><tr><th class="w-1/2">Check Point</th><th>Status</th><th>Remarks</th></tr></thead>
                      <tbody id="specific-container"></tbody>
                  </table>
              </div>
              
              <div id="fs-reviewer-section" class="glass-panel border-l-4 border-yellow-400 hidden">
                 <h3 class="font-bold text-lg text-yellow-700 mb-4">3. Reviewer Assessment</h3>
                 
                 <div class="mb-4">
                     <span class="font-bold text-sm block mb-2 text-gray-700">Hazards Identified:</span>
                     <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="hazards-container"></div>
                 </div>
                 
                 <div class="mb-4">
                     <span class="font-bold text-sm block mb-2 text-gray-700">PPE Required:</span>
                     <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="ppe-container"></div>
                 </div>

                 <div class="grid grid-cols-1 gap-3">
                    <textarea id="AdditionalPrecautions" name="AdditionalPrecautions" placeholder="Additional Precautions (if any)" rows="2"></textarea>
                    <textarea id="Reviewer_Remarks" name="Reviewer_Remarks" placeholder="Reviewer Remarks / Rejection Reason" rows="2" class="bg-yellow-50"></textarea>
                 </div>
              </div>

              <div id="fs-approver-section" class="glass-panel border-l-4 border-green-500 hidden">
                 <h3 class="font-bold text-lg text-green-700 mb-4">4. Final Approval</h3>
                 <textarea id="Approver_Remarks" name="Approver_Remarks" placeholder="Approver Remarks" rows="2" class="bg-green-50"></textarea>
              </div>

              <div id="renewals-section" class="glass-panel hidden">
                 <h3 class="font-bold text-lg text-gray-800 mb-4">Clearance Renewal History</h3>
                 <div class="overflow-x-auto mb-4 border rounded"><table class="w-full text-xs text-left"><thead class="bg-gray-100 border-b"><tr><th class="p-2">Period</th><th class="p-2">Readings</th><th class="p-2">Status</th><th class="p-2">Details</th></tr></thead><tbody id="renewals-table-body" class="divide-y"></tbody></table></div>
                 <div id="form-renewal" class="hidden bg-blue-50 p-4 rounded border border-blue-200">
                    <h4 class="font-bold text-blue-800 text-sm mb-3">New Renewal Request</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                       <div><label>Valid From</label><input type="datetime-local" id="RenewalValidFrom"></div>
                       <div><label>Valid To</label><input type="datetime-local" id="RenewalValidTill"></div>
                       <div><label>Gas Readings</label><input id="RenewalHC" placeholder="HC / Tox / O2"></div>
                       <div class="col-span-2 md:col-span-4"><label>Precautions</label><input id="RenewalPrecautions"></div>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" id="btn-submit-renewal" onclick="submitRenewal('approve')" class="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold">Submit Renewal</button>
                        <button type="button" id="btn-reject-renewal" onclick="rejectRenewal()" class="bg-red-600 text-white px-4 py-1 rounded text-sm font-bold hidden">Reject</button>
                    </div>
                 </div>
              </div>

              <div id="closure-section" class="glass-panel hidden">
                 <h3 class="font-bold text-lg text-gray-800 mb-4">Closure Workflow</h3>
                 <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded">
                     <label class="flex items-center gap-2 font-bold text-red-800 cursor-pointer">
                         <input type="checkbox" id="Site_Restored_Check" name="Site_Restored_Check">
                         I confirm that the Job Site is cleared and restored to Original condition.
                     </label>
                 </div>
                 
                 <div class="space-y-3">
                     <div id="div-closure-req" class="border p-3 rounded bg-gray-50 hidden">
                         <div class="flex justify-between text-xs font-bold text-gray-500 uppercase mb-1"><span>1. Requestor</span><span id="Closure_Requestor_Date"></span></div>
                         <textarea id="Closure_Requestor_Remarks" class="w-full text-sm p-2 border rounded" placeholder="Enter remarks..."></textarea>
                     </div>
                     <div id="div-closure-rev" class="border p-3 rounded bg-gray-50 hidden">
                         <div class="flex justify-between text-xs font-bold text-gray-500 uppercase mb-1"><span>2. Reviewer (Safety)</span><span id="Closure_Reviewer_Date"></span></div>
                         <textarea id="Closure_Reviewer_Remarks" class="w-full text-sm p-2 border rounded" placeholder="Enter verification remarks..."></textarea>
                     </div>
                     <div id="div-closure-app" class="border p-3 rounded bg-gray-50 hidden">
                         <div class="flex justify-between text-xs font-bold text-gray-500 uppercase mb-1"><span>3. Approver (Issuer)</span><span id="Closure_Approver_Date"></span></div>
                         <textarea id="Closure_Approver_Remarks" class="w-full text-sm p-2 border rounded" placeholder="Enter final closure remarks..."></textarea>
                     </div>
                 </div>
              </div>

              <div id="action-buttons" class="sticky bottom-0 bg-white p-4 border-t shadow-lg flex justify-end gap-3"></div>
              <div class="h-8"></div>
           </form>
        </div>
      </main>
    </div>

    <script>
      const API = "/api";
      let currentUser = null, currentPermitId = null;
      
      const questions = [{id:"GP_Q1", t:"Equip Inspected"}, {id:"GP_Q2", t:"Area Cleaned"}, {id:"GP_Q3", t:"Sewers Covered"}, {id:"GP_Q4", t:"Hazards Considered"}, {id:"GP_Q5", t:"Blinded", d:"GP_Q5_Detail"}, {id:"GP_Q6", t:"Depressurized"}, {id:"GP_Q7", t:"Steamed"}, {id:"GP_Q8", t:"Water Flushed"}, {id:"GP_Q9", t:"Fire Access"}, {id:"GP_Q10", t:"FeS Removed"}, {id:"GP_Q11", t:"Elec Isolated", d:"GP_Q11_Detail"}, {id:"GP_Q12", t:"Gas Test", gas:true}, {id:"GP_Q13", t:"Fire Extinguisher"}, {id:"GP_Q14", t:"Cordoned"}];
      const specific = [{id:"HW_Q1", t:"Ventilation"}, {id:"HW_Q2", t:"Exit Means"}, {id:"HW_Q3", t:"Standby"}, {id:"HW_Q4", t:"Trapped Gas"}, {id:"HW_Q5", t:"Spark Shield"}, {id:"HW_Q6", t:"Grounded"}, {id:"HW_Q16", t:"Height Permit", d:"HW_Q16_Detail"}, {id:"VE_Q1", t:"Spark Arrestor (Veh)"}, {id:"EX_Q1", t:"Excavation Clear"}];
      const hazards = ["H_H2S", "H_LackOxygen", "H_Corrosive", "H_ToxicGas", "H_Combustible", "H_Steam", "H_PyroIron", "H_N2Gas", "H_Height", "H_LooseEarth", "H_HighNoise", "H_Radiation", "H_Other"];
      const ppe = ["P_FaceShield", "P_FreshAirMask", "P_CompressedBA", "P_Goggles", "P_DustRespirator", "P_Earmuff", "P_LifeLine", "P_Apron", "P_SafetyHarness", "P_SafetyNet", "P_Airline", "P_GasResponder", "P_CottonCoverall"];

      document.addEventListener("DOMContentLoaded", () => { loadUsers(); buildUI(); });

      async function apiCall(ep, meth="GET", body=null) { 
          const opts = { method:meth, headers:{'Content-Type':'application/json'} }; 
          if(body) opts.body = JSON.stringify(body); 
          const res = await fetch(API+ep, opts); return await res.json(); 
      }

      async function loadUsers() { 
          const u = await apiCall('/users'); window.users = u; 
          const sel = document.getElementById("login-role"); 
          sel.innerHTML='<option value="">Select Role</option><option>Requester</option><option>Reviewer</option><option>Approver</option>'; 
          sel.onchange=()=>{ 
              const list=u[sel.value+'s']; 
              const n=document.getElementById("login-name"); 
              n.disabled=false; n.innerHTML=""; 
              list.forEach(x=>n.innerHTML+=`<option value="${x.email}">${x.name}</option>`); 
          }; 
      }

      async function handleLogin() { 
          const role=document.getElementById("login-role").value; 
          const name=document.getElementById("login-name").selectedOptions[0].text; 
          const email=document.getElementById("login-name").value; 
          const pass=document.getElementById("login-password").value; 
          const res=await apiCall('/login', 'POST', {role, name:email, password:pass}); 
          if(res.success) { 
              currentUser={...res.user, name}; 
              document.getElementById("view-login").style.display='none'; 
              document.getElementById("app-container").style.display='block'; 
              document.getElementById("user-info").innerText=`${name}`;
              document.getElementById("user-role-badge").innerText = role;
              updateRoleUI(); loadDashboard(); 
          } else alert(res.message); 
      }

      function updateRoleUI() { 
          const r = currentUser.Role; 
          if(r==='Requester') document.getElementById("btn-new-permit").classList.remove('hidden'); 
          if(r==='Reviewer'||r==='Approver') { 
              document.getElementById("btn-view-map").classList.remove('hidden'); 
              document.getElementById("btn-download-excel").classList.remove('hidden'); 
              document.getElementById("charts-container").classList.remove('hidden'); 
              document.getElementById("btn-add-user").classList.remove('hidden'); 
          } 
      }

      async function loadDashboard() { 
          const res=await apiCall('/dashboard', 'POST', {role:currentUser.Role, email:currentUser.Email}); 
          const list=document.getElementById("permit-list-body"); list.innerHTML=""; 
          res.forEach(p=>{ 
              list.innerHTML+=`
              <tr class="hover:bg-orange-50 cursor-pointer border-b" onclick="openPermit('${p.PermitID}')">
                  <td class="p-3 font-bold text-orange-600">${p.PermitID}</td>
                  <td>${p.WorkType}</td>
                  <td>${p.LocationUnit}</td>
                  <td>${p.RequesterName}</td>
                  <td><span class="bg-gray-200 text-gray-800 px-2 py-0.5 rounded text-xs font-bold">${p.Status}</span></td>
                  <td class="text-blue-600 font-bold">Open ></td>
              </tr>`; 
          }); 
      }

      // --- NEW PERMIT LOGIC ---
      function showNewPermit() { 
          document.getElementById("permit-form").reset(); 
          currentPermitId=null; 
          document.getElementById("Status").value="New"; 
          document.getElementById("RequesterName").value=currentUser.name; 
          document.getElementById("OfficialName").value=currentUser.name; 
          
          populateDropdowns(); 
          
          // HEADER UPDATE
          document.getElementById("permit-header-display").innerText = "New Permit: Final permit number will be allotted after successful submission.";
          document.getElementById("permit-header-display").className = "px-4 py-3 bg-blue-100 text-blue-800 border-l-4 border-blue-500 rounded mb-4 font-bold";

          document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false); 
          document.getElementById("OfficialName").disabled=true; 
          document.getElementById("RequesterName").disabled=true;
          
          document.getElementById("fs-reviewer-section").classList.add('hidden'); 
          document.getElementById("fs-approver-section").classList.add('hidden'); 
          document.getElementById("renewals-section").classList.add('hidden'); 
          document.getElementById("closure-section").classList.add('hidden'); 
          
          document.getElementById("action-buttons").innerHTML = `<button type="button" onclick="submitNewPermit()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-700">Submit Permit</button>`; 
          showForm(); 
      }

      function populateDropdowns() { 
          if (!window.users) return; 
          const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); 
          rS.innerHTML=""; aS.innerHTML=""; 
          window.users.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${u.name}</option>`); 
          window.users.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${u.name}</option>`); 
      }

      async function submitNewPermit() { 
          const vf = document.getElementById("ValidFrom").value; const vt = document.getElementById("ValidTo").value; 
          if(!vf || !vt) return alert("Please select dates"); 
          
          const fd=new FormData(document.getElementById("permit-form")); 
          document.querySelectorAll('input[type="checkbox"]').forEach(c=>fd.set(c.name, c.checked?"Y":"N")); 
          fd.append("RequesterEmail", currentUser.Email); 
          if(document.getElementById("H_Other").checked) fd.append("H_Other_Detail", document.getElementById("H_Other_Detail").value); 
          
          // If updating an existing pending permit
          if(currentPermitId && (document.getElementById("Status").value === 'Pending Review' || document.getElementById("Status").value === 'New')) { 
              fd.set("PermitID", currentPermitId); 
          } 
          
          const res=await fetch(API+'/save-permit', {method:'POST', body:fd}); 
          const json=await res.json(); 
          if(json.success){ alert("Saved: "+json.permitId); showDashboard(); } else alert(json.error); 
      }

      // --- OPEN PERMIT LOGIC ---
      async function openPermit(id) {
          const p = await apiCall('/permit-data', 'POST', {permitId:id}); 
          currentPermitId=id; 
          populateDropdowns(); 
          
          // HEADER UPDATE
          document.getElementById("permit-header-display").innerText = `PERMIT NO: ${id} (Status: ${p.Status})`;
          const statusColor = p.Status === 'Active' ? 'green' : (p.Status === 'Rejected' ? 'red' : 'orange');
          document.getElementById("permit-header-display").className = `px-4 py-3 bg-${statusColor}-100 text-${statusColor}-800 border-l-4 border-${statusColor}-500 rounded mb-4 font-bold`;

          // LOCK ALL FIELDS INITIALLY
          document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=true); 
          
          // FILL DATA
          Object.keys(p).forEach(key=>{ 
              const el=document.getElementById(key); 
              if(el) { if(el.type==='checkbox')el.checked=(p[key]==='Y'); else el.value=p[key]; } 
              const radios = document.querySelectorAll(`input[name="${key}"]`); 
              if(radios.length>0) radios.forEach(r=>{ if(r.value===p[key]) r.checked=true; }); 
              const checks = document.querySelectorAll(`input[type="checkbox"][name="${key}"]`); 
              if(checks.length>0) checks.forEach(c=>{ if(p[key]==='Y') c.checked=true; }); 
          });

          // SHOW/HIDE SECTIONS based on Status & Role
          document.getElementById("fs-reviewer-section").classList.add('hidden'); 
          document.getElementById("fs-approver-section").classList.add('hidden'); 
          document.getElementById("renewals-section").classList.add('hidden'); 
          document.getElementById("closure-section").classList.add('hidden'); 
          document.getElementById("btn-reject-renewal").classList.add('hidden');
          
          const btns = document.getElementById("action-buttons"); btns.innerHTML=""; 
          const r=currentUser.Role; const s=p.Status;

          // FILL CLOSURE DATA
          if(p.Closure_Requestor_Remarks) document.getElementById("Closure_Requestor_Remarks").value = p.Closure_Requestor_Remarks; 
          if(p.Closure_Requestor_Date) document.getElementById("Closure_Requestor_Date").innerText = p.Closure_Requestor_Date; 
          if(p.Closure_Reviewer_Remarks) document.getElementById("Closure_Reviewer_Remarks").value = p.Closure_Reviewer_Remarks; 
          if(p.Closure_Reviewer_Date) document.getElementById("Closure_Reviewer_Date").innerText = p.Closure_Reviewer_Date; 
          if(p.Closure_Approver_Remarks) document.getElementById("Closure_Approver_Remarks").value = p.Closure_Approver_Remarks; 
          if(p.Closure_Approver_Date) document.getElementById("Closure_Approver_Date").innerText = p.Closure_Approver_Date;
          
          // STATUS HANDLERS
          if(s.includes('Pending Review')) { 
              if(r === 'Requester') { 
                  // Requestor Can Edit
                  document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false); 
                  document.getElementById("OfficialName").disabled=true; 
                  document.getElementById("RequesterName").disabled=true;
                  btns.innerHTML = `<button type="button" onclick="submitNewPermit()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Update Permit</button>`; 
              } 
              if(r === 'Reviewer') { 
                  document.getElementById("fs-reviewer-section").classList.remove('hidden'); 
                  document.getElementById("Reviewer_Remarks").disabled=false; 
                  document.querySelectorAll('#fs-reviewer-section input, #fs-reviewer-section textarea').forEach(e=>e.disabled=false); 
                  document.getElementById("H_Other").onchange = function() { toggleOtherHazard(this); }; 
                  btns.innerHTML = `<button type="button" onclick="upd('reject')" class="bg-red-500 text-white px-4 py-2 rounded font-bold">Reject</button><button type="button" onclick="upd('review')" class="bg-emerald-600 text-white px-4 py-2 rounded font-bold">Submit Review</button>`; 
              } 
          }

          if(s.includes('Pending Approval')) { 
              document.getElementById("fs-reviewer-section").classList.remove('hidden'); 
              if(r==='Approver') { 
                  document.getElementById("fs-approver-section").classList.remove('hidden'); 
                  document.getElementById("Approver_Remarks").disabled=false; 
                  document.getElementById("ForceBackgroundColor").disabled=false; 
                  btns.innerHTML = `<button type="button" onclick="upd('reject')" class="bg-red-500 text-white px-4 py-2 rounded font-bold">Reject</button><button type="button" onclick="upd('approve')" class="bg-emerald-600 text-white px-4 py-2 rounded font-bold">Approve</button>`; 
              } 
          }

          if(s==='Active' || s.includes('Renewal')) { 
              // Show All Data Read-only
              document.getElementById("fs-reviewer-section").classList.remove('hidden'); 
              document.getElementById("fs-approver-section").classList.remove('hidden'); 
              document.getElementById("renewals-section").classList.remove('hidden'); 
              document.getElementById("closure-section").classList.remove('hidden'); 
              
              let html = `<a href="${API}/download-pdf/${currentPermitId}" target="_blank" class="bg-gray-800 text-white px-4 py-2 rounded font-bold">Download PDF</a>`; 
              
              if(r==='Requester' && s === 'Active') { 
                  document.getElementById("form-renewal").classList.remove('hidden'); 
                  document.querySelectorAll("#form-renewal input").forEach(e=>e.disabled=false); 
                  document.getElementById("btn-submit-renewal").innerText = "Submit Renewal"; 
                  html += `<button type="button" onclick="upd('initiate_closure')" class="bg-amber-500 text-white px-4 py-2 rounded font-bold ml-2">Job Complete (Initiate Closure)</button>`; 
                  document.getElementById("div-closure-req").classList.remove('hidden'); 
                  document.getElementById("Closure_Requestor_Remarks").disabled = false; 
              } 
              btns.innerHTML = html; 
          }

          if(s.includes('Closure') || s === 'Closed') { 
              document.getElementById("fs-reviewer-section").classList.remove('hidden'); 
              document.getElementById("fs-approver-section").classList.remove('hidden'); 
              document.getElementById("closure-section").classList.remove('hidden'); 
              
              document.getElementById("div-closure-req").classList.remove('hidden');
              if(s.includes('Pending Approval') || s === 'Closed') document.getElementById("div-closure-rev").classList.remove('hidden');
              if(s === 'Closed') document.getElementById("div-closure-app").classList.remove('hidden');

              if(s === 'Closure Pending Review' && r === 'Reviewer') { 
                  document.getElementById("div-closure-rev").classList.remove('hidden');
                  document.getElementById("Closure_Reviewer_Remarks").disabled = false; 
                  btns.innerHTML = `<button type="button" onclick="upd('reject_closure')" class="bg-red-500 text-white px-4 py-2 rounded font-bold">Reject</button><button type="button" onclick="upd('approve')" class="bg-emerald-600 text-white px-4 py-2 rounded font-bold">Verify Closure</button>`; 
              } 
              else if(s === 'Closure Pending Approval' && r === 'Approver') { 
                  document.getElementById("div-closure-app").classList.remove('hidden');
                  document.getElementById("Closure_Approver_Remarks").disabled = false; 
                  btns.innerHTML = `<button type="button" onclick="upd('reject_closure')" class="bg-red-500 text-white px-4 py-2 rounded font-bold">Reject</button><button type="button" onclick="upd('approve')" class="bg-black text-white px-4 py-2 rounded font-bold">Final Close</button>`; 
              } 
              else if (s === 'Closed') { 
                  btns.innerHTML = `<a href="${API}/download-pdf/${currentPermitId}" target="_blank" class="bg-gray-800 text-white px-4 py-2 rounded font-bold">Download Closed Permit</a>`; 
              } 
          }
          
          showForm();
      }

      function populateRenewalForm(data) { /* ... same as before ... */ }
      async function upd(act) { 
          const body={ 
              PermitID:currentPermitId, action:act, role:currentUser.Role, user:currentUser.name, 
              comment:currentUser.Role==='Reviewer'?document.getElementById("Reviewer_Remarks").value:document.getElementById("Approver_Remarks").value, 
              ForceBackgroundColor:document.getElementById("ForceBackgroundColor").value, 
              WorkType:document.getElementById("WorkType").value, 
              Closure_Requestor_Remarks:document.getElementById("Closure_Requestor_Remarks").value, 
              Closure_Reviewer_Remarks:document.getElementById("Closure_Reviewer_Remarks").value, 
              Closure_Approver_Remarks:document.getElementById("Closure_Approver_Remarks").value 
          }; 
          // Include Hazards/PPE if Reviewer
          if(currentUser.Role==='Reviewer' && !act.includes('closure')) { 
              document.querySelectorAll('#hazards-container input, #ppe-container input').forEach(c=>body[c.name]=c.checked?"Y":"N"); 
              body.AdditionalPrecautions=document.getElementById("AdditionalPrecautions").value; 
              if(document.getElementById("H_Other").checked) body.H_Other_Detail = document.getElementById("H_Other_Detail").value; 
          } 
          const res=await apiCall('/update-status', 'POST', body); 
          if(res.success) showDashboard(); else alert(res.error); 
      }
      
      // ... Other helper functions (getGeo, buildUI, etc) remain the same ...
      function toggleOtherHazard(el) { const input = document.getElementById("H_Other_Detail"); if(el.checked) { input.classList.remove("hidden"); input.disabled = false; } else { input.classList.add("hidden"); input.value = ""; } }
      function getGeo() { navigator.geolocation.getCurrentPosition(p=>{document.getElementById("Latitude").value=p.coords.latitude;document.getElementById("Longitude").value=p.coords.longitude;}); }
      
      function buildUI() { 
          const c=document.getElementById("checklist-container"); c.innerHTML=""; 
          questions.forEach(q=>{
              if(q.gas) {
                  c.innerHTML+=`
                  <tr>
                    <td>${q.t}</td>
                    <td class="flex gap-2">
                        <label><input type="radio" name="${q.id}" value="Yes"> Yes</label>
                        <label><input type="radio" name="${q.id}" value="NA"> NA</label>
                    </td>
                    <td>
                        <div class="grid grid-cols-3 gap-1">
                            <input id="${q.id}_ToxicGas" placeholder="Tox" class="border w-full text-xs rounded px-1">
                            <input id="${q.id}_HC" placeholder="HC" class="border w-full text-xs rounded px-1">
                            <input id="${q.id}_Oxygen" placeholder="O2" class="border w-full text-xs rounded px-1">
                        </div>
                    </td>
                  </tr>`;
              } else {
                  c.innerHTML+=`
                  <tr>
                    <td>${q.t}</td>
                    <td class="flex gap-2">
                        <label><input type="radio" name="${q.id}" value="Yes"> Yes</label>
                        <label><input type="radio" name="${q.id}" value="NA"> NA</label>
                    </td>
                    <td>
                        ${q.d ? `<input id="${q.d}" name="${q.d}" class="border w-full text-xs rounded px-1">` : ''}
                    </td>
                  </tr>`;
              }
          });
          
          const sc=document.getElementById("specific-container"); sc.innerHTML=""; 
          specific.forEach(q=>{
              sc.innerHTML+=`
              <tr>
                <td>${q.t}</td>
                <td class="flex gap-2">
                    <label><input type="radio" name="${q.id}" value="Yes"> Yes</label>
                    <label><input type="radio" name="${q.id}" value="NA"> NA</label>
                </td>
                <td>
                    ${q.d ? `<input id="${q.d}" name="${q.d}" class="border w-full text-xs rounded px-1">` : ''}
                </td>
              </tr>`;
          });

          const hc = document.getElementById("hazards-container"); hc.innerHTML = "";
          hazards.forEach(h => {
              if (h.replace('H_','') === 'Other') {
                  hc.innerHTML += `<div class="col-span-2 md:col-span-4 border p-1 rounded bg-white shadow-sm flex items-center gap-2"><label class="flex items-center gap-2 cursor-pointer font-bold text-red-600 text-[10px]"><input type="checkbox" id="${h}" name="${h}" value="Y" onchange="toggleOtherHazard(this)"> Other Hazards</label><input id="H_Other_Detail" name="H_Other_Detail" class="w-full hidden border rounded px-1 text-xs" placeholder="Specify..."></div>`;
              } else {
                  hc.innerHTML += `<label class="flex items-center gap-1 border p-1 rounded bg-white hover:bg-gray-50 text-[10px] cursor-pointer"><input type="checkbox" id="${h}" name="${h}" value="Y" class="rounded text-indigo-600"> ${h.replace('H_','')}</label>`;
              }
          });
          
          document.getElementById("ppe-container").innerHTML=ppe.map(p=>`<label class="flex items-center gap-1 border p-1 rounded bg-white hover:bg-gray-50 text-[10px] cursor-pointer"><input type="checkbox" id="${p}" name="${p}" value="Y" class="rounded text-indigo-600"> ${p.replace('P_','')}</label>`).join(''); 
      }

      function showMap() { document.getElementById("view-dashboard").style.display='none'; document.getElementById("view-map-container").classList.remove('hidden'); loadMapData(); }
      async function loadMapData() { const points = await apiCall('/map-data', 'POST'); if(!mapInstance) mapInstance = new google.maps.Map(document.getElementById("map"), {center: {lat:26.11, lng:85.39}, zoom:8}); const list = document.getElementById("active-permit-list"); list.innerHTML = ""; points.forEach(pt => { const item = document.createElement("div"); item.className = "permit-item p-2 cursor-pointer bg-white rounded shadow-sm hover:shadow-md"; item.innerHTML = `<div class="font-bold text-indigo-600">${pt.PermitID}</div><div class="text-xs text-gray-600">${pt.WorkType}</div><div class="text-[10px] text-gray-400">${pt.ExactLocation}</div>`; item.onclick = () => flyToPermit(pt); list.appendChild(item); const marker = new google.maps.Marker({ position: {lat: pt.lat, lng: pt.lng}, map: mapInstance, title: pt.PermitID, animation: google.maps.Animation.DROP }); const infoWindow = new google.maps.InfoWindow({ content: `<div style="color:black"><b>${pt.PermitID}</b><br>${pt.WorkType}<br>Status: Active</div>` }); marker.addListener("click", () => { infoWindow.open(mapInstance, marker); mapInstance.setZoom(15); mapInstance.setCenter(marker.getPosition()); }); markers[pt.PermitID] = {marker, infoWindow}; }); }
      function flyToPermit(pt) { const mData = markers[pt.PermitID]; if(mData) { mapInstance.setZoom(16); mapInstance.panTo(mData.marker.getPosition()); mData.infoWindow.open(mapInstance, mData.marker); mData.marker.setAnimation(google.maps.Animation.BOUNCE); setTimeout(() => mData.marker.setAnimation(null), 3000); } }
      function showAddUser() { document.getElementById("view-dashboard").style.display='none'; document.getElementById("view-add-user").classList.remove("hidden"); }
      async function submitNewUser() { const n=document.getElementById("new-user-name").value; const e=document.getElementById("new-user-email").value; const r=document.getElementById("new-user-role").value; const p=document.getElementById("new-user-pass").value; const res = await apiCall('/add-user', 'POST', {name:n, email:e, role:r, password:p}); if(res.success) { alert("User Created!"); showDashboard(); } else alert(res.error); }
      function showForm() { document.getElementById("view-dashboard").style.display='none'; document.getElementById("view-form").style.display='block'; window.scrollTo(0,0); }
      function showDashboard() { document.getElementById("view-dashboard").style.display='block'; document.getElementById("view-form").style.display='none'; document.getElementById("view-map-container").classList.add('hidden'); document.getElementById("view-add-user").classList.add('hidden'); loadDashboard(); }
    </script>
  </body>
</html>
