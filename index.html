<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ERPL Mainline Permit System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU" async></script>

    <style nonce="NONCE_PLACEHOLDER">
        /* --- GLOBAL LAYOUT RESET --- */
        body { 
            background-color: #f3f4f6; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; /* Prevent body scroll, handle in containers */
            margin: 0;
            padding: 0;
        }

        /* --- REQ A: GLOBAL LOADER OVERLAY --- */
        .loader-overlay { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.92); 
            z-index: 10000; /* Highest z-index */
            display: none; /* Hidden by default */
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            backdrop-filter: blur(2px);
        }
        
        .spinner { 
            border: 5px solid #e5e7eb; /* Light grey */
            border-top: 5px solid #ea580c; /* Orange-600 */
            border-radius: 50%; 
            width: 60px; 
            height: 60px; 
            animation: spin 0.8s linear infinite; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* --- REQ D: SANDWICH LAYOUT STRUCTURE --- */
        #main-wrapper { 
            display: flex; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
        }
        
        /* LEFT SIDEBAR (Navigation) */
        .sidebar-left { 
            width: 280px; 
            background: #0f172a; /* Slate-900 */
            color: #e2e8f0; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            z-index: 50;
        }
        
        /* RIGHT SIDEBAR (Info/Stats/Validity) */
        .sidebar-right { 
            width: 320px; 
            background: #ffffff; 
            border-left: 1px solid #e5e7eb; 
            overflow-y: auto; 
            flex-shrink: 0; 
            padding: 1.5rem; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            z-index: 40;
            box-shadow: -4px 0 15px rgba(0,0,0,0.05);
        } 

        /* CENTER CONTENT (The "Meat" of the Sandwich) */
        .content-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 2rem; 
            background: #f8fafc; /* Slate-50 */
            position: relative; 
            scroll-behavior: smooth;
        }

        /* --- REQ C: 3 COLUMN CHECKLIST GRID --- */
        .checklist-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); /* 3 Columns Fixed */
            gap: 1rem; 
            width: 100%;
        }

        /* --- RESPONSIVE BREAKPOINTS --- */
        /* Large Tablets / Small Laptops */
        @media(max-width: 1280px) { 
            .checklist-grid { grid-template-columns: repeat(2, 1fr); } 
            .sidebar-right { width: 280px; }
        }

        /* Tablets (Portrait) */
        @media(max-width: 1024px) { 
            .sidebar-right { display: none; } /* Hide right sidebar to save space */
            .checklist-grid { grid-template-columns: 1fr; } /* Stack checklists */
        }

        /* Mobile Phones */
        @media(max-width: 768px) { 
            .sidebar-left { 
                position: absolute; 
                left: -280px; /* Hide off-screen */
                height: 100%; 
                top: 0;
            }
            .sidebar-left.open { 
                left: 0; /* Slide in */
            }
            .content-area { padding: 1rem; }
            .checklist-grid { grid-template-columns: 1fr; }
        }

        /* --- UI COMPONENTS & FORM ELEMENTS --- */
        .glass { 
            background: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            border: 1px solid #e2e8f0; 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            transition: transform 0.2s ease-in-out;
        }
        
        /* Input Styling */
        input, select, textarea { 
            width: 100%; 
            border: 1px solid #cbd5e1; 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            font-size: 0.95rem; 
            margin-bottom: 0.75rem; 
            background-color: #fff; 
            transition: all 0.2s;
            color: #1e293b;
        }
        
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #f97316; /* Orange-500 */
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15); 
        }
        
        input:disabled, select:disabled, textarea:disabled { 
            background-color: #f1f5f9; /* Slate-100 */
            color: #64748b; 
            cursor: not-allowed; 
            border-color: #e2e8f0;
        }

        /* Navigation Items */
        .nav-item { 
            padding: 1rem 1.5rem; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            color: #94a3b8; /* Slate-400 */
            transition: all 0.2s; 
            border-left: 4px solid transparent; 
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .nav-item:hover { 
            background: #1e293b; /* Slate-800 */
            color: #f8fafc; 
        }
        
        .nav-item.active { 
            background: #334155; /* Slate-700 */
            color: #ffffff; 
            border-left-color: #f97316; /* Orange-500 */
        }
        
        /* Data Tables */
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9rem;
        }
        
        .data-table th { 
            background: #f8fafc; 
            color: #475569; 
            font-weight: 700; 
            padding: 1rem; 
            text-align: left; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            border-bottom: 2px solid #e2e8f0; 
        }
        
        .data-table td { 
            padding: 1rem; 
            border-bottom: 1px solid #e2e8f0; 
            vertical-align: middle; 
            color: #334155;
        }
        
        .data-table tr:hover { 
            background: #f1f5f9; 
            cursor: pointer; 
        }
        
        /* Utility Classes for Deleted/Edited Logic */
        .marked-deleted { 
            text-decoration: line-through; 
            opacity: 0.5; 
            background-color: #fef2f2; 
        }

        /* Modal Transitions */
        .animate-scale-up {
            animation: scaleUp 0.3s ease-out forwards;
        }
        @keyframes scaleUp {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <div class="mt-6 font-bold text-orange-600 animate-pulse text-xl tracking-wide">Processing Request...</div>
        <div class="text-xs text-gray-400 mt-2">Please wait while we communicate with the server</div>
    </div>

    <div id="view-login" class="fixed inset-0 bg-gradient-to-br from-orange-50 to-orange-100 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md shadow-2xl rounded-xl border-t-8 border-orange-600 p-8 transform transition-all animate-scale-up">
            <div class="text-center mb-8">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <img src="/public/logo.png" class="h-16 object-contain" alt="IOCL Logo">
                    <img src="/public/rhino.png" class="h-16 object-contain" alt="Rhino Logo">
                </div>
                <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">IndianOil</h1>
                <p class="text-sm text-gray-500 font-bold uppercase tracking-widest mt-1">Mainline Permit System</p>
            </div>
            
            <form id="login-form" class="space-y-5">
                <div class="p-5 bg-gray-50 rounded-lg border border-gray-200 space-y-4 relative">
                    <div class="absolute -top-3 left-3 bg-gray-50 px-2 text-xs font-bold text-gray-400 uppercase">Location Details</div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">1. Pipeline Region</label>
                        <select id="login-region" class="bg-white border-gray-300 focus:ring-2 focus:ring-orange-500">
                            <option value="">Loading Regions...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">2. Unit / Section</label>
                        <select id="login-unit" class="bg-white border-gray-300 focus:ring-2 focus:ring-orange-500" disabled>
                            <option value="">Select Region First</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">3. Pipeline Location</label>
                        <select id="login-loc" class="bg-white border-gray-300 focus:ring-2 focus:ring-orange-500" disabled>
                            <option value="">Select Unit First</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">4. Role</label>
                        <select id="login-role" class="bg-white border-gray-300 focus:ring-2 focus:ring-orange-500">
                            <option>Requester</option>
                            <option>Reviewer</option>
                            <option>Approver</option>
                            <option>MasterAdmin</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">5. User</label>
                        <select id="login-user" class="bg-white border-gray-300 focus:ring-2 focus:ring-orange-500" disabled>
                            <option value="">Select Location & Role</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Password</label>
                    <input type="password" id="login-pass" class="bg-white border-gray-300 focus:ring-2 focus:ring-orange-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button type="submit" class="w-full bg-orange-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-orange-700 shadow-lg transition transform hover:-translate-y-0.5 active:translate-y-0">
                    Secure Login üîí
                </button>
                <p class="text-center text-xs text-gray-400 mt-4">Authorized Personnel Only. All actions are logged.</p>
            </form>
        </div>
    </div>

    <div id="view-pwd-change" class="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center hidden backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm p-8 rounded-xl border-l-8 border-red-600 shadow-2xl animate-scale-up">
            <h3 class="font-bold text-2xl mb-2 text-red-600 flex items-center gap-2">
                <span class="text-3xl">‚ö†</span> Action Required
            </h3>
            <p class="text-gray-600 mb-6 leading-relaxed text-sm">
                Security Policy: You are using a temporary or default password. You must change it now to proceed.
            </p>
            
            <label class="text-xs font-bold text-gray-500 uppercase block mb-1">New Password</label>
            <input type="password" id="new-pwd-1" placeholder="Enter new secure password" class="mb-4">
            
            <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Confirm Password</label>
            <input type="password" id="new-pwd-2" placeholder="Re-enter password" class="mb-6">
            
            <button id="btn-force-pwd" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 shadow-md transition">
                Update Password & Login
            </button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="main-wrapper">
            
            <div class="sidebar-left" id="sidebar">
                <div class="p-6 font-bold text-xl text-orange-500 border-b border-gray-700 flex items-center gap-3 bg-gray-900 shadow-sm">
                    <img src="/public/rhino.png" class="h-8 w-8 bg-white rounded-full p-1"> 
                    <span>ERPL Permit</span>
                </div>
                
                <div id="user-display" class="p-5 text-xs text-gray-300 bg-gray-800 border-b border-gray-700 font-mono leading-relaxed">
                    </div>

                <nav class="flex-1 overflow-y-auto mt-4 space-y-1 px-3">
                    <div class="nav-item active" onclick="switchView('dashboard')" id="nav-dashboard">
                        <span class="text-lg">üìä</span> Dashboard
                    </div>
                    <div class="nav-item hidden" onclick="switchView('new-permit')" id="nav-new-permit">
                        <span class="text-lg">üìù</span> Create Permit
                    </div>
                    <div class="nav-item" onclick="switchView('workers')" id="nav-workers">
                        <span class="text-lg">üë∑</span> Worker Management
                    </div>
                    <div class="nav-item hidden" id="nav-users" onclick="switchView('users')">
                        <span class="text-lg">üë•</span> User Management
                    </div>
                    <div class="nav-item" onclick="switchView('map')" id="nav-map">
                        <span class="text-lg">üó∫Ô∏è</span> Live Map View
                    </div>
                    <div class="nav-item hidden" id="nav-admin" onclick="switchView('admin')">
                        <span class="text-lg">üîê</span> Master Admin Console
                    </div>
                </nav>

                <div class="p-4 border-t border-gray-700 bg-gray-900">
                    <div class="nav-item text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded justify-center transition" onclick="logout()">
                        <span class="text-lg">üö™</span> Sign Out
                    </div>
                </div>
            </div>

            <div class="content-area">
                <button class="md:hidden mb-6 text-gray-600 bg-white p-3 rounded-lg shadow hover:bg-gray-50 flex items-center gap-2" onclick="document.getElementById('sidebar').classList.toggle('open')">
                    <span class="text-xl">‚ò∞</span> Menu
                </button>
                
                <div id="view-dashboard">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Permit Dashboard</h2>
                            <p class="text-sm text-gray-500 mt-1">Real-time overview of permit activities for your location</p>
                        </div>
                        <button id="dash-btn-new" onclick="switchView('new-permit')" class="hidden bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-lg shadow-lg font-bold hover:from-orange-600 hover:to-orange-700 hover:-translate-y-1 transition transform flex items-center gap-2">
                            <span>+</span> Create New Permit
                        </button>
                    </div>
                    
                    <div id="dashboard-content" class="space-y-8">
                        <div class="text-center text-gray-400 py-10">Loading Dashboard Data...</div>
                    </div>
                </div>

                <div id="view-form" class="hidden">
                    <div class="flex justify-between items-center mb-6 sticky top-0 bg-gray-50/95 backdrop-blur-sm z-30 py-4 border-b border-gray-200 px-1 shadow-sm">
                        <button onclick="switchView('dashboard')" class="text-blue-600 font-bold flex items-center gap-2 hover:bg-blue-50 px-4 py-2 rounded-lg transition">
                            <span>‚Üê</span> Back to Dashboard
                        </button>
                        <div class="text-right">
                            <h2 class="text-xl font-bold text-gray-800" id="permit-title">New Permit Application</h2>
                            <p class="text-xs text-gray-500 font-mono" id="permit-subtitle">Draft Mode</p>
                        </div>
                    </div>

                    <form id="pf" class="max-w-7xl mx-auto space-y-6 pb-24">
                        <input type="hidden" id="PermitID" name="PermitID">
                        <input type="hidden" id="Status" name="Status">
                        
                        <div class="glass border-t-4 border-orange-500">
                            <h3 class="font-bold text-orange-600 border-b pb-3 mb-6 text-lg flex items-center gap-2">
                                <span>1Ô∏è‚É£</span> Basic Details
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Work Type</label>
                                    <select name="WorkType" id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option></select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Specific Work Activity</label>
                                    <input name="WorkTypeOther" id="WorkTypeOther" placeholder="E.g., Welding on Line 2">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Exact Location (GPS)</label>
                                    <div class="flex gap-2">
                                        <input name="ExactLocation" id="ExactLocation" class="flex-1" placeholder="Coordinates (Lat, Long)">
                                        <button type="button" id="btn-get-geo" class="bg-blue-100 text-blue-700 px-4 rounded-lg font-bold hover:bg-blue-200 transition border border-blue-200 flex items-center gap-2">
                                            <span>üìç</span> Get GPS
                                        </button>
                                    </div>
                                    <input type="hidden" id="Latitude" name="Latitude"><input type="hidden" id="Longitude" name="Longitude">
                                </div>
                                
                                <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Location Description</label><input name="WorkLocationDetail" id="WorkLocationDetail"></div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Section/Unit</label><input name="LocationUnit" id="LocationUnit" value="Pipeline"></div>
                                
                                <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Valid From</label><input type="datetime-local" name="ValidFrom" id="ValidFrom"></div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Valid To</label><input type="datetime-local" name="ValidTo" id="ValidTo"></div>
                                
                                <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Vendor Name</label><input name="Vendor" id="Vendor" readonly class="bg-gray-100 cursor-not-allowed"></div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Requester Name</label><input name="RequesterName" id="RequesterName" readonly class="bg-gray-100 cursor-not-allowed"></div>
                                
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Issued To Dept</label><input name="IssuedToDept" id="IssuedToDept"></div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Security Guard</label><input name="SecurityGuard" id="SecurityGuard"></div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Emergency Contact</label><input name="EmergencyContact" id="EmergencyContact"></div>
                                
                                <div class="md:col-span-4">
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Description of Work</label>
                                    <textarea name="Desc" id="Desc" rows="3" placeholder="Detailed description of the job..."></textarea>
                                </div>
                                
                                <div class="md:col-span-2 border-t pt-4 mt-2">
                                    <label class="text-xs font-bold text-blue-600 uppercase block mb-1">Assign Reviewer</label>
                                    <select name="ReviewerEmail" id="ReviewerEmail" class="border-blue-200 bg-blue-50"></select>
                                </div>
                                <div class="md:col-span-2 border-t pt-4 mt-2">
                                    <label class="text-xs font-bold text-green-600 uppercase block mb-1">Assign Approver</label>
                                    <select name="ApproverEmail" id="ApproverEmail" class="border-green-200 bg-green-50"></select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="init-renewal-wrapper" class="glass border-l-8 border-purple-500 bg-purple-50 hidden">
                            <label class="flex items-center gap-3 font-bold cursor-pointer text-purple-900 text-lg p-2 rounded hover:bg-purple-100 transition">
                                <input type="checkbox" name="InitRen" value="Y" id="chk-init-renewal" class="w-6 h-6 accent-purple-600 rounded"> 
                                <span>Request 1st Renewal with Permit Creation</span>
                            </label>
                            <div id="div-init-renewal" class="hidden mt-4 pl-8 border-t border-purple-200 pt-4 animate-scale-up">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div><label class="text-xs font-bold text-gray-500 block mb-1">Renewal From</label><input type="datetime-local" name="InitRenFrom"></div>
                                    <div><label class="text-xs font-bold text-gray-500 block mb-1">Renewal To</label><input type="datetime-local" name="InitRenTo"></div>
                                </div>
                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <div><label class="text-xs font-bold text-gray-500 block mb-1">HC %</label><input name="InitRenHC" placeholder="%"></div>
                                    <div><label class="text-xs font-bold text-gray-500 block mb-1">Toxic PPM</label><input name="InitRenTox" placeholder="PPM"></div>
                                    <div><label class="text-xs font-bold text-gray-500 block mb-1">Oxygen %</label><input name="InitRenO2" placeholder="%"></div>
                                </div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">Special Precautions</label><input name="InitRenPrec" placeholder="Special Precautions for Renewal"></div>
                                </div>
                        </div>

                        <div id="checklists-container" class="space-y-6">
                            </div>

                        <div class="glass border-t-4 border-blue-500">
                            <h3 class="font-bold text-blue-600 border-b pb-3 mb-6 text-lg flex items-center gap-2">
                                <span>3Ô∏è‚É£</span> Worker Deployment
                            </h3>
                            <div id="worker-select-area" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4"></div>
                            <div id="worker-display-table" class="hidden overflow-x-auto mt-2 rounded border">
                                <table class="w-full text-xs text-left data-table">
                                    <thead><tr class="bg-gray-100"><th>Name</th><th>ID Type/No</th><th>Contact</th></tr></thead>
                                    <tbody id="worker-display-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="glass border-t-4 border-red-500">
                            <h3 class="font-bold text-red-600 border-b pb-3 mb-6 text-lg flex items-center gap-2">
                                <span>4Ô∏è‚É£</span> Hazards & PPE
                            </h3>
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Identified Hazards</h4>
                                <div id="hazards-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                                <div id="other-hazard-div" class="hidden mt-3">
                                    <input id="H_Others_Detail" name="H_Others_Detail" placeholder="Specify other hazards..." class="border-red-300 bg-red-50 text-red-800">
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Required PPE</h4>
                                <div id="ppe-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                            </div>
                        </div>
                        
                        <div id="fs-reviewer-section" class="glass hidden border-l-8 border-yellow-500 bg-yellow-50/20">
                            <h3 class="font-bold text-yellow-700 mb-4 text-lg border-b border-yellow-200 pb-2">Reviewer Action</h3>
                            <div class="mb-6 hidden" id="iocl-reviewer-wrapper">
                                <label class="font-bold text-xs text-gray-500 uppercase block mb-2">Authorized IOCL Supervisors</label>
                                <div id="iocl-sup-container-rev" class="space-y-2 mb-2"></div>
                                <button type="button" id="btn-add-rev-sup" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded hover:bg-gray-50 font-bold shadow-sm">+ Add Supervisor</button>
                            </div>
                            <label class="font-bold text-xs text-gray-500 uppercase block mb-1">Reviewer Remarks</label>
                            <textarea name="Reviewer_Remarks" id="Reviewer_Remarks" placeholder="Enter remarks..." class="w-full mb-3"></textarea>
                            <label class="font-bold text-xs text-gray-500 uppercase block mb-1">Additional Precautions</label>
                            <textarea name="AdditionalPrecautions" id="AdditionalPrecautions" placeholder="Any additional safety measures..." class="w-full"></textarea>
                        </div>

                        <div id="fs-approver-section" class="glass hidden border-l-8 border-green-500 bg-green-50/20">
                            <h3 class="font-bold text-green-700 mb-4 text-lg border-b border-green-200 pb-2">Approver Action</h3>
                            <div class="mb-6 hidden" id="iocl-approver-wrapper">
                                <label class="font-bold text-xs text-gray-500 uppercase block mb-2">Authorized IOCL Supervisors</label>
                                <div id="iocl-sup-container-app" class="space-y-2 mb-2"></div>
                                <button type="button" id="btn-add-app-sup" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded hover:bg-gray-50 font-bold shadow-sm">+ Add Supervisor</button>
                            </div>
                            <label class="font-bold text-xs text-gray-500 uppercase block mb-1">Approver Remarks</label>
                            <textarea name="Approver_Remarks" id="Approver_Remarks" placeholder="Enter final remarks..." class="w-full mb-4"></textarea>
                            
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" name="RequireRenewalPhotos" id="RequireRenewalPhotos" value="Y" class="w-5 h-5 accent-green-600 rounded">
                                    <span class="font-bold text-green-800">Require Photo Evidence for ALL Renewals?</span>
                                </label>
                                <p class="text-xs text-green-600 mt-1 ml-8">If checked, requester must upload a photo for every renewal request, including the first one.</p>
                            </div>
                            
                            <div id="pdf-color-select" class="mt-4 hidden p-2 bg-gray-100 rounded">
                                <label class="text-xs font-bold uppercase text-gray-500 mr-2">PDF Background Color:</label>
                                <select id="PdfBgColor" class="w-auto inline-block mb-0"><option>White</option><option>Red</option><option>Green</option><option>Yellow</option><option>Auto</option></select>
                            </div>
                        </div>

                        <div id="renewals-section" class="glass hidden border-l-8 border-purple-600 bg-purple-50/10">
                            <h3 class="font-bold text-purple-700 border-b pb-3 mb-6 text-lg flex items-center gap-2">
                                <span>üìÖ</span> Renewal History & Requests
                            </h3>
                            
                            <div class="overflow-x-auto mb-6 bg-white rounded-lg shadow-sm border border-gray-200">
                                <table class="w-full text-xs text-left data-table">
                                    <thead><tr class="bg-purple-100 text-purple-900"><th>Period</th><th>Gas/Prec</th><th>Workers</th><th>Status</th><th>Photo</th></tr></thead>
                                    <tbody id="renewal-history-body"></tbody>
                                </table>
                            </div>

                            <div id="form-renewal" class="hidden bg-white p-6 rounded-lg border border-purple-200 shadow-md">
                                <h4 class="font-bold text-purple-800 text-lg mb-4 border-b pb-2">New Renewal Request</h4>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                    <div><label class="text-xs font-bold text-gray-500 block mb-1">From</label><input type="datetime-local" id="RenewalValidFrom"></div>
                                    <div><label class="text-xs font-bold text-gray-500 block mb-1">To</label><input type="datetime-local" id="RenewalValidTo"></div>
                                    <div><label class="text-xs font-bold text-gray-500 block mb-1">HC %</label><input id="RenewalHC"></div>
                                    <div><label class="text-xs font-bold text-gray-500 block mb-1">Oxygen %</label><input id="RenewalOxygen"></div>
                                </div>
                                
                                <div id="odd-hour-agreement" class="hidden mb-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded shadow-sm">
                                    <label class="flex items-start gap-3 cursor-pointer">
                                        <input type="checkbox" id="OddHourSafetyCheck" class="mt-1 w-5 h-5 accent-indigo-600">
                                        <div>
                                            <span class="text-sm font-bold text-indigo-900">Odd Hour Work Declaration</span>
                                            <p class="text-xs text-indigo-700 mt-1">I agree to ensure proper lighting, safety measures, and alertness of all workers during these hours.</p>
                                        </div>
                                    </label>
                                </div>

                                <div class="mb-4">
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Specific Precautions</label>
                                    <input id="RenewalPrec" placeholder="Precautions for this shift...">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="text-xs font-bold text-gray-500 mb-1 block">Select Workers for this Shift</label>
                                    <div class="bg-gray-50 p-3 rounded border border-gray-200 max-h-40 overflow-y-auto grid grid-cols-2 gap-2" id="renewal-worker-select"></div>
                                </div>

                                <div id="renewal-photo-wrapper" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                                    <label class="block text-sm font-bold text-red-700 uppercase mb-2">üì∏ Mandatory Site Condition Photo</label>
                                    <input type="file" id="ren-cam-sub" accept="image/*" capture="environment" class="w-full text-sm bg-white border border-red-300 p-2 rounded">
                                    <p class="text-xs text-red-500 mt-1 font-bold" id="photo-mandate-msg">Proof of site condition is required by the Approver.</p>
                                </div>

                                <button type="button" onclick="submitRenewal('pending_review')" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow hover:bg-purple-700 transition transform hover:-translate-y-0.5">Submit Renewal Request</button>
                            </div>
                        </div>

                        <div id="closure-section" class="glass hidden border-l-8 border-gray-600">
                            <h3 class="font-bold text-gray-700 border-b pb-2 mb-4 text-lg">Work Completion & Closure</h3>
                            <label class="flex items-center gap-3 mb-6 font-bold text-red-600 p-4 bg-red-50 rounded-lg border border-red-100 cursor-pointer hover:bg-red-100 transition shadow-sm">
                                <input type="checkbox" id="Site_Restored_Check" name="Site_Restored_Check" class="w-6 h-6 accent-red-600 rounded"> 
                                <span class="text-lg">I confirm Site is Restored, Materials Removed & Housekeeping Done.</span>
                            </label>
                            
                            <div id="div-closure-req" class="hidden space-y-3 mb-4">
                                <label class="text-xs font-bold text-gray-500 uppercase">Requester Remarks</label>
                                <textarea id="Closure_Requestor_Remarks" placeholder="Enter closure remarks..." class="w-full"></textarea>
                                <span id="ts-clos-req" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                            <div id="div-closure-rev" class="hidden space-y-3 mb-4 border-t pt-4">
                                <label class="text-xs font-bold text-gray-500 uppercase">Reviewer Remarks</label>
                                <textarea id="Closure_Reviewer_Remarks" placeholder="Enter closure remarks..." class="w-full"></textarea>
                                <span id="ts-clos-rev" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                            <div id="div-closure-app" class="hidden space-y-3 border-t pt-4">
                                <label class="text-xs font-bold text-gray-500 uppercase">Approver Remarks</label>
                                <textarea id="Closure_Approver_Remarks" placeholder="Enter closure remarks..." class="w-full"></textarea>
                                <span id="ts-clos-app" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                        </div>

                        <div class="glass" id="section-e">
                            <h3 class="font-bold text-gray-600 border-b pb-3 mb-4 uppercase text-sm tracking-wide">E. References</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">SOP/SWP No</label><input name="SopNo" id="SopNo"></div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">JSA No</label><input name="JsaNo" id="JsaNo"></div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">Work Order</label><input name="WorkOrder" id="WorkOrder"></div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">IOCL Equip</label><input name="IoclEquip" id="IoclEquip"></div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">Contractor Equip</label><input name="ContEquip" id="ContEquip"></div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">Tool Box Talk</label><input name="ToolBoxTalk" id="ToolBoxTalk"></div>
                            </div>
                        </div>

                        <div id="gsr-container" class="glass border-l-4 border-orange-600 bg-orange-50 hidden">
                            <label class="flex items-start gap-4 p-2 cursor-pointer">
                                <input type="checkbox" id="gsr-check" name="GSR_Check_Box" class="mt-1 w-6 h-6 text-orange-600 rounded focus:ring-orange-500 shrink-0">
                                <span class="text-sm font-bold text-gray-800 text-justify leading-relaxed">
                                    I have read, understood and accepted all terms, conditions and non-compliance penalty of IOCL Golden Safety Rules. I shall ensure all workers are complied to all these rules and in case of any violation, penalty will be imposed by IOCL and I shall accept such penalties without any further challenge.
                                </span>
                            </label>
                        </div>

                        <div id="actions-bar" class="flex flex-col md:flex-row justify-end gap-3 bg-white p-6 shadow-[0_-10px_25px_-5px_rgba(0,0,0,0.1)] border-t sticky bottom-0 z-40 rounded-t-2xl">
                            </div>
                    </form>
                </div>

                <div id="view-workers" class="hidden">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800">Worker Management</h2>
                            <p class="text-sm text-gray-500">Manage your workforce and their approvals</p>
                        </div>
                        <button onclick="openWorkerModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg font-bold hover:bg-blue-700 transition flex items-center gap-2">
                            <span>+</span> Add Worker
                        </button>
                    </div>
                    <div class="glass overflow-x-auto shadow-md rounded-lg p-0">
                        <table class="w-full text-sm text-left data-table" id="table-workers">
                            <thead class="bg-gray-100"><tr><th>Name</th><th>ID Type/No</th><th>Role</th><th>Status</th><th>Approver</th><th>Action</th></tr></thead>
                            <tbody class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-users" class="hidden">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800">User Management</h2>
                            <p class="text-sm text-gray-500">Manage portal access for your designated location</p>
                        </div>
                        <button onclick="document.getElementById('view-add-user').classList.remove('hidden')" class="bg-purple-600 text-white px-6 py-3 rounded-lg shadow-lg font-bold hover:bg-purple-700 transition flex items-center gap-2">
                            <span>+</span> Add New User
                        </button>
                    </div>
                    <div class="glass overflow-x-auto shadow-md rounded-lg p-0">
                        <table class="w-full text-sm text-left data-table" id="table-manage-users">
                            <thead class="bg-gray-100 text-gray-700"><tr><th>Name</th><th>Email</th><th>Role</th><th>Location</th><th>Action</th></tr></thead>
                            <tbody class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-admin" class="hidden">
                    <h2 class="text-3xl font-bold mb-8 text-gray-800 border-b pb-4">Master Admin Console</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        
                        <div class="glass border-t-8 border-purple-600 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl">üìÇ</div>
                            <h3 class="font-bold text-xl mb-4 text-purple-800">Bulk User Upload</h3>
                            <p class="text-sm text-gray-500 mb-6 bg-purple-50 p-3 rounded-lg border border-purple-100">
                                Upload an Excel file (.xlsx) to create multiple users at once.
                                <br><strong>Columns:</strong> Name, Email, Role, Password, Region, Unit, Location.
                            </p>
                            <input type="file" id="bulk-excel" accept=".xlsx" class="mb-4 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 transition">
                            <button onclick="uploadBulkUsers()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 shadow-md transition transform hover:-translate-y-0.5">Upload & Map Users</button>
                        </div>

                        <div class="glass border-t-8 border-red-600 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl">üîë</div>
                            <h3 class="font-bold text-xl mb-4 text-red-800">Global Password Reset</h3>
                            <p class="text-sm text-gray-500 mb-6 bg-red-50 p-3 rounded-lg border border-red-100">
                                Force reset a user's password. They will be required to change it immediately upon their next login.
                            </p>
                            <input id="reset-email" placeholder="User Email Address" class="mb-3">
                            <input id="reset-temp-pass" placeholder="Set Temporary Password" class="mb-6">
                            <button onclick="resetUserPassword()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 shadow-md transition transform hover:-translate-y-0.5">Reset Password</button>
                        </div>
                    </div>
                </div>

                <div id="view-map" class="hidden h-full">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Live Permit Map</h2>
                    <div class="glass h-[700px] w-full p-0 overflow-hidden shadow-inner border-2 border-gray-200 rounded-xl relative">
                        <div id="map" class="w-full h-full"></div>
                        <div class="absolute bottom-4 left-4 bg-white/90 p-3 rounded shadow-lg backdrop-blur text-xs">
                            <div class="font-bold mb-1">Status Legend</div>
                            <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> Action Req</div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> Active</div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="sidebar-right">
                <div class="mb-8">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider border-b pb-2">Live Stats</h3>
                    <div class="h-48 relative">
                        <canvas id="chartStatus"></canvas>
                    </div>
                </div>

                <div id="validity-box" class="hidden mb-6 p-6 bg-gradient-to-b from-green-50 to-white border border-green-200 rounded-xl shadow-sm text-center">
                    <div class="text-xs font-bold text-green-800 uppercase mb-3 tracking-wide">Current Permit Validity</div>
                    <div id="val-time-from" class="text-base font-mono font-bold text-gray-800"></div>
                    <div class="text-center text-gray-400 text-sm my-1">‚¨á</div>
                    <div id="val-time-to" class="text-base font-mono font-bold text-gray-800"></div>
                    <div id="val-status" class="mt-4 inline-block px-4 py-1 rounded-full bg-green-600 text-white text-xs font-bold shadow-sm uppercase tracking-wider">ACTIVE</div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider border-b pb-2">Quick Info</h3>
                    <div id="right-panel-info" class="text-sm text-gray-500 italic bg-gray-50 p-4 rounded-lg border border-gray-200 leading-relaxed">
                        Select a permit from the dashboard table to view detailed status and actions here.
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-worker" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden animate-scale-up">
            <div class="bg-blue-600 p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg text-white">Worker Profile</h3>
                <button onclick="document.getElementById('modal-worker').classList.add('hidden')" class="text-white hover:text-gray-200 text-xl font-bold">‚úï</button>
            </div>
            <form id="worker-form-real" class="p-6 grid grid-cols-2 gap-4">
                <input id="w-id" type="hidden">
                <div class="col-span-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Full Name</label>
                    <input id="w-name" placeholder="Name" required>
                </div>
                <div class="col-span-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Father's Name</label>
                    <input id="w-father" placeholder="Father Name" required>
                </div>
                <div class="col-span-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Address</label>
                    <input id="w-address" placeholder="Residential Address">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Age</label>
                    <input id="w-age" placeholder="Age" type="number" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Gender</label>
                    <select id="w-gender"><option>Male</option><option>Female</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Contact</label>
                    <input id="w-contact" placeholder="Mobile No">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">ID Type</label>
                    <select id="w-id-type"><option value="Voter Card">Voter Card</option><option value="PAN Card">PAN Card</option><option value="Other">Other</option></select>
                </div>
                <input id="w-id-type-other" placeholder="Specify ID" class="hidden col-span-2 bg-yellow-50 border-yellow-200">
                <div class="col-span-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">ID Number</label>
                    <input id="w-idcard" placeholder="ID Number">
                </div>
                <button type="submit" class="col-span-2 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow transition transform hover:-translate-y-0.5">Save Worker Details</button>
            </form>
        </div>
    </div>
    
    <div id="view-add-user" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden animate-scale-up">
            <div class="bg-purple-600 p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg text-white">Create New User</h3>
                <button onclick="document.getElementById('view-add-user').classList.add('hidden')" class="text-white hover:text-gray-200 text-xl font-bold">‚úï</button>
            </div>
            <form id="adduser-form" class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Full Name</label>
                    <input id="new-user-name" placeholder="Name" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Email</label>
                    <input id="new-user-email" placeholder="Email" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Role</label>
                    <select id="new-user-role"><option>Requester</option><option>Reviewer</option><option>Approver</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Initial Password</label>
                    <input id="new-user-pass" type="password" placeholder="Password" required>
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow hover:bg-purple-700 transition">Create User</button>
            </form>
        </div>
    </div>

    <script nonce="NONCE_PLACEHOLDER">
        const API = "/api";
        let authToken = null, currentUser = null;
        let mapInstance = null, chartS = null;
        let currentPermitId = null, currentPermitWorkers = [], currentRenewalCount = 0, permitRequirePhoto = false, currentPermitIOCLData = [];
        let isRefreshing = false;

        // --- CONSTANTS ---
        const CL_DATA = { 
            A: ["1. Equipment / Work Area inspected.", "2. Surrounding area checked.", "3. Manholes covered.", "4. Hazards considered.", "5. Equipment blinded.", "6. Drained.", "7. Steamed.", "8. Flushed.", "9. Fire Access.", "10. Iron Sulfide.", "11. Electrical Isolation.", "12. Gas Test.", "13. Firefighting.", "14. Cordoned.", "15. CCTV.", "16. Ventilation."], 
            B: ["1. Exit.", "2. Standby.", "3. Gas trap.", "4. Spark shield.", "5. Grounding.", "6. Standby (Confined).", "7. Communication.", "8. Rescue.", "9. Cooling.", "10. Inert Gas.", "11. ELCB.", "12. Cylinders.", "13. Spark arrestor.", "14. Welding loc.", "15. Height."], 
            C: ["1. PESO spark elimination."], 
            D: ["1. Shoring.", "2. Soil distance.", "3. Access.", "4. Vehicle ban."] 
        };
        const HAZARDS = ["Lack of Oxygen", "H2S", "Toxic Gases", "Combustible gases", "Pyrophoric Iron", "Corrosive Chemicals", "cave in formation", "Others"];
        const PPE = ["Helmet", "Safety Shoes", "Hand gloves", "Boiler suit", "Face Shield", "Apron", "Goggles", "Dust Respirator", "Fresh Air Mask", "Lifeline", "Safety Harness", "Airline", "Earmuff", "IFR"];

        // --- REQ A: GLOBAL LOADER ---
        async function apiCall(ep, meth="GET", body=null, isPdfDownload=false) {
            if(!isPdfDownload) document.getElementById('loader').style.display = 'flex';
            try {
                const headers = {'Content-Type':'application/json'};
                if(authToken) headers['Authorization'] = `Bearer ${authToken}`;
                const opts = {method:meth, headers:headers};
                if(body) opts.body = JSON.stringify(body);
                opts.credentials = 'include';
                
                const res = await fetch(API+ep, opts);
                
                // Auth Refresh Logic can go here (simplified for this snippet)
                if(res.status === 401) { 
                    alert("Session Expired"); location.reload(); return; 
                }
                
                if(isPdfDownload) return res; 
                return await res.json();
            } catch(e) { 
                console.error(e); 
                return {error: "Network Error"}; 
            } finally { 
                if(!isPdfDownload) document.getElementById('loader').style.display = 'none'; 
            }
        }

        // --- HELPER FUNCTIONS ---
        function escapeHtml(text) { if (!text) return text; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function safeSet(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
        function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
        function getNow() { return new Date().toLocaleString("en-GB").replace(',',''); }

        // --- REQ F: HIERARCHY LOGIN LOGIC ---
        async function initLogin() {
            // Load Regions
            const regions = await apiCall('/get-hierarchy', 'POST', {});
            const rSel = document.getElementById('login-region');
            rSel.innerHTML = `<option value="">Select Region</option>` + regions.map(r=>`<option>${r}</option>`).join('');
            
            // Cascading Logic
            rSel.addEventListener('change', async (e) => {
                const uSel = document.getElementById('login-unit'); 
                uSel.disabled=true; uSel.innerHTML='<option>Loading...</option>';
                const units = await apiCall('/get-hierarchy', 'POST', {region: e.target.value});
                uSel.innerHTML = `<option value="">Select Unit</option>` + units.map(u=>`<option>${u}</option>`).join('');
                uSel.disabled = false;
            });

            document.getElementById('login-unit').addEventListener('change', async (e) => {
                const lSel = document.getElementById('login-loc'); 
                lSel.disabled=true; lSel.innerHTML='<option>Loading...</option>';
                const locs = await apiCall('/get-hierarchy', 'POST', {region: document.getElementById('login-region').value, unit: e.target.value});
                lSel.innerHTML = `<option value="">Select Location</option>` + locs.map(l=>`<option>${l}</option>`).join('');
                lSel.disabled = false;
            });

            // User Loader
            const loadUsers = async () => {
                const reg = document.getElementById('login-region').value;
                const unit = document.getElementById('login-unit').value;
                const loc = document.getElementById('login-loc').value;
                const role = document.getElementById('login-role').value;
                
                if(reg && unit && loc && role) {
                    const uSel = document.getElementById('login-user'); 
                    uSel.innerHTML='<option>Loading...</option>';
                    const users = await apiCall('/get-users-by-loc', 'POST', {region:reg, unit:unit, location:loc, role:role});
                    uSel.innerHTML = users.map(u=>`<option value="${u.Email}">${u.Name}</option>`).join('');
                    uSel.disabled = false;
                }
            }

            document.getElementById('login-loc').addEventListener('change', loadUsers);
            document.getElementById('login-role').addEventListener('change', loadUsers);
        }

        // --- REQ B: STRICT FILE VALIDATION ---
        function attachFileValidators() {
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', function() {
                    const file = this.files[0];
                    if(file) {
                        // REQ B: Reject non-images
                        if(!file.type.startsWith('image/')) {
                            alert("SECURITY WARNING: Only Image files (JPG/PNG) are allowed. PDF/Docs are strictly prohibited for this field.");
                            this.value = ''; 
                        }
                    }
                });
            });
        }

        // --- LOGIN HANDLER ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const res = await apiCall('/login', 'POST', {email, password: pass});
            
            if(res.forceChange) {
                // REQ I: Show Force Change Modal
                document.getElementById('view-pwd-change').classList.remove('hidden');
                document.getElementById('view-pwd-change').dataset.email = res.email;
            } else if(res.success) {
                authToken = res.token; 
                currentUser = res.user; 
                enterApp();
            } else { 
                alert(res.msg || "Login Failed"); 
            }
        });

        // --- REQ I: FORCE PASSWORD CHANGE ---
        document.getElementById('btn-force-pwd').addEventListener('click', async () => {
            const p1 = document.getElementById('new-pwd-1').value; 
            const p2 = document.getElementById('new-pwd-2').value;
            const email = document.getElementById('view-pwd-change').dataset.email;
            
            if(p1 !== p2) return alert("Passwords do not match");
            if(p1.length < 6) return alert("Password too short");
            
            const res = await apiCall('/force-password-change', 'POST', {email, newPassword: p1});
            if(res.success) { 
                alert("Password updated successfully. Please login with new credentials."); 
                location.reload(); 
            } else {
                alert("Update failed");
            }
        });

        // --- ADD USER (Approver) ---
        document.getElementById('adduser-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                name: document.getElementById("new-user-name").value,
                email: document.getElementById("new-user-email").value,
                role: document.getElementById("new-user-role").value,
                password: document.getElementById("new-user-pass").value
            };
            const res = await apiCall('/add-user', 'POST', body);
            if(res.success) { 
                alert("User Added Successfully"); 
                document.getElementById('view-add-user').classList.add('hidden'); 
                loadManageUsers(); // Refresh list
            } else {
                alert(res.error || "Failed to add user");
            }
        });

        // --- ENTER APP (UI INITIALIZATION) ---
        function enterApp() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Populate Sidebar Info
            document.getElementById('user-display').innerHTML = `
                <div class="font-bold text-white text-lg">${currentUser.Name}</div>
                <div class="text-orange-400 font-bold uppercase text-xs tracking-wider">${currentUser.Role}</div>
                <div class="text-xs mt-2 text-gray-500 font-mono flex items-center gap-1">
                    <span>üìç</span> ${currentUser.Location}
                </div>`;
            
            // Role Based Nav Visibility
            if(currentUser.Role === 'Requester') document.getElementById('nav-new-permit').classList.remove('hidden');
            if(currentUser.Role === 'MasterAdmin') document.getElementById('nav-admin').classList.remove('hidden');
            if(currentUser.Role === 'Approver' || currentUser.Role === 'MasterAdmin') document.getElementById('nav-users').classList.remove('hidden');
            
            renderChecklists(); 
            renderHazards(); 
            switchView('dashboard');
        }

        // --- RENDER UI HELPERS ---
        function renderChecklists() {
            const container = document.getElementById('checklists-container'); 
            container.innerHTML = '';
            Object.keys(CL_DATA).forEach(sec => {
                // REQ C: 3 Column Grid Layout
                container.innerHTML += `
                    <div class="glass border-t-4 border-gray-400">
                        <h4 class="font-bold text-gray-700 border-b pb-2 mb-4 text-sm uppercase tracking-wide bg-gray-50 p-2 rounded">
                            Section ${sec} Checks
                        </h4>
                        <div class="checklist-grid">
                            ${CL_DATA[sec].map((item, i) => `
                                <div class="p-3 border rounded-lg bg-white text-xs hover:shadow-md transition flex flex-col justify-between h-full">
                                    <p class="mb-3 font-semibold text-gray-700 leading-snug">${item}</p>
                                    <div class="flex gap-2 mt-auto bg-gray-50 p-1 rounded justify-center">
                                        <label class="cursor-pointer flex items-center gap-1 px-2 py-1 hover:bg-green-100 rounded">
                                            <input type="radio" name="${sec}_${i}" value="Y" checked class="accent-green-600"> Y
                                        </label>
                                        <label class="cursor-pointer flex items-center gap-1 px-2 py-1 hover:bg-red-100 rounded">
                                            <input type="radio" name="${sec}_${i}" value="N" class="accent-red-600"> N
                                        </label>
                                        <label class="cursor-pointer flex items-center gap-1 px-2 py-1 hover:bg-gray-200 rounded">
                                            <input type="radio" name="${sec}_${i}" value="NA" class="accent-gray-600"> NA
                                        </label>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>`;
            });
        }

        function renderHazards() {
            document.getElementById('hazards-grid').innerHTML = HAZARDS.map(h => 
                `<label class="flex items-center gap-2 p-3 border rounded-lg bg-gray-50 text-xs cursor-pointer hover:bg-orange-100 transition shadow-sm font-bold text-gray-700 select-none">
                    <input type="checkbox" name="H_${h.replace(/ /g,'')}" value="Y" class="accent-orange-600 w-4 h-4"> ${h}
                </label>`
            ).join('');
            
            document.getElementById('ppe-grid').innerHTML = PPE.map(p => 
                `<label class="flex items-center gap-2 p-3 border rounded-lg bg-gray-50 text-xs cursor-pointer hover:bg-blue-100 transition shadow-sm font-bold text-gray-700 select-none">
                    <input type="checkbox" name="P_${p.replace(/ /g,'')}" value="Y" class="accent-blue-600 w-4 h-4"> ${p}
                </label>`
            ).join('');

            // Toggle 'Other' Hazard Input
            const otherCheck = document.querySelector('input[name="H_Others"]');
            if(otherCheck) {
                otherCheck.addEventListener('change', (e) => {
                    document.getElementById('other-hazard-div').classList.toggle('hidden', !e.target.checked);
                });
            }
            
            // Toggle ID Type Input
            document.getElementById('w-id-type').addEventListener('change', (e) => {
                document.getElementById('w-id-type-other').classList.toggle('hidden', e.target.value !== 'Other');
            });
        }

        // --- NAVIGATION SWITCHER ---
        function switchView(viewName) {
            // Hide all content views
            document.querySelectorAll('.content-area > div').forEach(d => d.classList.add('hidden'));
            // Reset Nav Active States
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Map names to IDs
            const viewMap = {
                'dashboard': 'view-dashboard', 
                'new-permit': 'view-form', 
                'workers': 'view-workers', 
                'users': 'view-users', 
                'map': 'view-map', 
                'admin': 'view-admin'
            };
            
            // Show Target View
            if(document.getElementById(viewMap[viewName])) {
                document.getElementById(viewMap[viewName]).classList.remove('hidden');
                
                // Highlight corresponding nav item
                let navId = 'nav-' + viewName;
                if(viewName === 'dashboard') navId = 'nav-dashboard'; // Special case if needed
                
                // Find nav item by onclick attribute or ID
                const navItem = document.getElementById(navId) || 
                                document.querySelector(`.nav-item[onclick*="${viewName}"]`);
                
                if(navItem) navItem.classList.add('active');
            }
            
            // View Specific Logic
            if(viewName === 'dashboard') loadDashboard();
            if(viewName === 'new-permit') attachFileValidators();
            if(viewName === 'users') loadManageUsers();
            if(viewName === 'workers') loadWorkers('mgmt');
        }

        // --- USER MANAGEMENT LOGIC ---
        async function loadManageUsers() {
             const t = document.querySelector('#table-manage-users tbody'); 
             t.innerHTML = '<tr><td colspan="5" class="text-center p-4">Loading...</td></tr>';
             
             const roles = ['Requester', 'Reviewer', 'Approver'];
             let allUsers = [];
             
             // Fetch users for each role in current location
             // (MasterAdmin logic would fetch ALL locations - simplified here for this file)
             for(let r of roles) {
                 const u = await apiCall('/get-users-by-loc', 'POST', { 
                     region: currentUser.Region, 
                     unit: currentUser.Unit, 
                     location: currentUser.Location, 
                     role: r 
                 });
                 if(Array.isArray(u)) allUsers = [...allUsers, ...u];
             }
             
             t.innerHTML = '';
             if(allUsers.length === 0) {
                 t.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500 italic">No users found for your location.</td></tr>`;
             } else {
                 allUsers.forEach(u => {
                     // Can only delete if not self
                     const delBtn = u.Email !== currentUser.Email ? 
                        `<button class="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1 rounded font-bold text-xs transition" onclick="deleteUser('${u.Email}')">Delete</button>` : 
                        '<span class="text-gray-400 text-xs">Me</span>';
                        
                     t.innerHTML += `<tr class="hover:bg-gray-50 transition border-b border-gray-100">
                        <td class="p-3"><div class="font-bold text-gray-800">${u.Name}</div></td>
                        <td class="p-3 text-gray-600 font-mono text-xs">${u.Email}</td>
                        <td class="p-3"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold uppercase">${u.Role}</span></td>
                        <td class="p-3 text-gray-500 text-xs">${currentUser.Location}</td>
                        <td class="p-3">${delBtn}</td>
                     </tr>`;
                 });
             }
        }
        
        async function deleteUser(email) {
            if(!confirm(`PERMANENT ACTION:\n\nAre you sure you want to delete user ${email}?\nThis cannot be undone.`)) return;
            
            // NOTE: Backend endpoint /api/delete-user is assumed present or needs adding to server.js
            // Simulating success for UI demonstration if endpoint missing
            alert(`Delete request sent for ${email}. (Backend implementation required for persistent delete)`);
            // await apiCall('/delete-user', 'POST', {email}); loadManageUsers();
        }

        // --- DASHBOARD LOGIC ---
        async function loadDashboard() {
            const res = await apiCall('/dashboard', 'POST', {role: currentUser.Role, email: currentUser.Email});
            const container = document.getElementById('dashboard-content'); 
            container.innerHTML = '';
            
            const pending = res.filter(p => p.Status.includes('Pending'));
            const active = res.filter(p => p.Status === 'Active' || p.Status.includes('Renewal'));
            const closed = res.filter(p => p.Status.includes('Closed') || p.Status === 'Rejected');
            
            const renderTable = (title, items, color) => {
                if(items.length === 0) return '';
                return `
                    <div class="glass border-l-4 border-${color}-500 transform transition hover:shadow-lg">
                        <div class="flex justify-between items-center border-b pb-2 mb-3">
                            <h3 class="font-bold text-${color}-700 uppercase text-sm tracking-wide flex items-center gap-2">
                                <span class="h-3 w-3 rounded-full bg-${color}-500"></span> ${title}
                            </h3>
                            <span class="bg-${color}-100 text-${color}-800 text-xs font-bold px-3 py-1 rounded-full border border-${color}-200">${items.length}</span>
                        </div>
                        <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs data-table">
                            <thead><tr><th>Permit ID</th><th>Type</th><th>Location</th><th>Status</th><th>Valid From</th></tr></thead>
                            <tbody>${items.map(p => `
                                <tr onclick="openPermit('${p.PermitID}')" class="group hover:bg-${color}-50 transition">
                                    <td class="font-bold text-blue-600 group-hover:underline">${p.PermitID}</td>
                                    <td class="font-medium">${p.WorkType}</td>
                                    <td class="text-gray-500">${p.LocationUnit}</td>
                                    <td><span class="px-2 py-0.5 rounded bg-${color}-50 text-${color}-700 font-bold border border-${color}-200 text-[10px] uppercase">${p.Status}</span></td>
                                    <td class="font-mono text-gray-500">${p.ValidFrom.split('T')[0]}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                        </div>
                    </div>`;
            };
            
            container.innerHTML += renderTable('Action Required', pending, 'red');
            container.innerHTML += renderTable('Active Permits', active, 'green');
            container.innerHTML += renderTable('Closed / Archived', closed, 'gray');
            
            if(res.length === 0) {
                container.innerHTML = `<div class="text-center p-10 text-gray-400 bg-white rounded-lg border border-dashed border-gray-300">No permits found.</div>`;
            }
            
            loadStats(res);
        }

        // --- OPEN PERMIT LOGIC ---
        async function openPermit(id) {
            const p = await apiCall('/permit-data', 'POST', {permitId:id});
            document.getElementById('view-dashboard').classList.add('hidden'); 
            document.getElementById('view-form').classList.remove('hidden');
            
            document.getElementById('permit-title').innerText = `Permit #${id}`;
            document.getElementById('permit-subtitle').innerText = `Status: ${p.Status}`;
            
            // Populate Fields
            document.querySelectorAll('#pf input, #pf textarea, #pf select').forEach(el => {
                if(el.type === 'checkbox') el.checked = (p[el.name] === 'Y'); 
                else if(el.type !== 'file') el.value = p[el.name] || ''; 
                el.disabled = true; // Read Only
            });

            // REQ E: Validity Display
            document.getElementById('validity-box').classList.remove('hidden');
            document.getElementById('val-time-from').innerText = p.ValidFrom.replace('T', ' '); 
            document.getElementById('val-time-to').innerText = p.ValidTo.replace('T', ' ');
            document.getElementById('val-status').innerText = p.Status.toUpperCase();

            // Renewal & Photo Logic
            const rens = JSON.parse(p.RenewalsJSON || "[]");
            const permitRequirePhoto = (p.RequireRenewalPhotos === 'Y');
            const canRenew = (currentUser.Role === 'Requester' && (p.Status === 'Active' || p.Status.includes('Renewal')));
            
            // Show Renewal Section?
            if (rens.length > 0 || canRenew) {
                document.getElementById('renewals-section').classList.remove('hidden');
                
                const histBody = document.getElementById('renewal-history-body');
                histBody.innerHTML = rens.map(r => `
                    <tr class="border-b border-gray-100 hover:bg-purple-50">
                        <td class="p-2 font-mono text-[10px]">${r.valid_from}<br>${r.valid_to}</td>
                        <td class="p-2">HC:${r.hc}% Tox:${r.toxic}</td>
                        <td class="p-2">${r.worker_list?.length || 0}</td>
                        <td class="p-2 font-bold text-purple-700">${r.status}</td>
                        <td class="p-2 text-center">${r.photoUrl ? 'üì∏' : '-'}</td>
                    </tr>`).join('');
                    
                if (canRenew) {
                    document.getElementById('form-renewal').classList.remove('hidden');
                    
                    // --- CORRECTED PHOTO LOGIC: MANDATORY ON 1ST RENEWAL IF FLAG SET ---
                    // Previous code checked (currentRenewalCount > 0 && flag). 
                    // We REMOVED currentRenewalCount > 0.
                    if (permitRequirePhoto) {
                        document.getElementById('renewal-photo-wrapper').classList.remove('hidden');
                        document.getElementById('ren-cam-sub').required = true;
                    } else {
                        document.getElementById('renewal-photo-wrapper').classList.add('hidden');
                        document.getElementById('ren-cam-sub').required = false;
                    }
                } else {
                    document.getElementById('form-renewal').classList.add('hidden');
                }
            } else { 
                document.getElementById('renewals-section').classList.add('hidden'); 
            }
            
            attachFileValidators();
        }

        // --- SUBMIT RENEWAL ---
        async function submitRenewal(status) {
             const getVal = (id) => document.getElementById(id).value;
            const fd = new FormData();
            fd.append('PermitID', document.getElementById('PermitID').value);
            fd.append('action', 'initiate'); 
            fd.append('RenewalValidFrom', getVal("RenewalValidFrom"));
            fd.append('RenewalValidTo', getVal("RenewalValidTo"));
            fd.append('hc', getVal("RenewalHC")); 
            fd.append('toxic', getVal("RenewalToxic")); 
            fd.append('oxygen', getVal("RenewalOxygen"));
            fd.append('precautions', getVal("RenewalPrec"));
            
            // Check Photo Mandatory
            const fileInput = document.getElementById("ren-cam-sub");
            const isPhotoMandatory = !document.getElementById('renewal-photo-wrapper').classList.contains('hidden');
            
            if(isPhotoMandatory && fileInput.files.length === 0) {
                alert("‚õî MANDATORY: You must upload a site condition photo before submitting this renewal.");
                return;
            }
            if(fileInput.files.length > 0) fd.append('RenewalImage', fileInput.files[0]);

            const res = await fetch(API+'/renewal', {method:'POST', body:fd, headers: {'Authorization': `Bearer ${authToken}`}});
            const json = await res.json();
            if(json.success) { alert("Renewal Request Submitted!"); switchView('dashboard'); } else alert(json.error);
        }

        // --- WORKER FUNCTIONS (CRUD) ---
        function openWorkerModal() { 
            document.getElementById('worker-form-real').reset(); 
            window.currentWorkerAction = 'create';
            document.getElementById('modal-worker').classList.remove('hidden'); 
        }

        document.getElementById('worker-form-real').addEventListener('submit', async (e) => {
            e.preventDefault();
            const idTypeRaw = document.getElementById("w-id-type").value;
            const idTypeFinal = idTypeRaw === "Other" ? document.getElementById("w-id-type-other").value : idTypeRaw;
            
            const body = {
                Action: window.currentWorkerAction,
                Role: currentUser.Role,
                RequestorEmail: currentUser.Email,
                RequestorName: currentUser.Name,
                WorkerID: document.getElementById('w-id').value,
                Details: {
                    Name: document.getElementById("w-name").value,
                    Age: document.getElementById("w-age").value,
                    Father: document.getElementById("w-father").value,
                    Address: document.getElementById("w-address").value,
                    Contact: document.getElementById("w-contact").value,
                    ID: document.getElementById("w-idcard").value,
                    Gender: document.getElementById("w-gender").value,
                    IDType: idTypeFinal
                }
            };
            const res = await apiCall('/save-worker', 'POST', body);
            if(res.success) { 
                alert("Worker Saved Successfully"); 
                document.getElementById('modal-worker').classList.add('hidden'); 
                loadWorkers('mgmt'); 
            } else {
                alert(res.error);
            }
        });

        async function loadWorkers(context) { 
            const res = await apiCall('/get-workers', 'POST', {role:currentUser.Role, email:currentUser.Email, context:context}); 
            
            if(context === 'permit_dropdown') { 
                // Populate the grid in Permit Form
                const con = document.getElementById('worker-select-area');
                con.innerHTML = res.map(w => `
                    <label class="flex items-center gap-3 border p-3 rounded-lg bg-white shadow-sm cursor-pointer hover:bg-blue-50 transition">
                        <input type="checkbox" name="Worker_${w.WorkerID}" value='${JSON.stringify(w)}' class="w-5 h-5 accent-blue-600 rounded"> 
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${escapeHtml(w.Name)}</div>
                            <div class="text-xs text-gray-500">${w.IDType}: ${w.ID}</div>
                        </div>
                    </label>`).join(''); 
            } else { 
                // Populate Management Table
                const t = document.querySelector('#table-workers tbody'); 
                t.innerHTML = "";
                res.forEach(w => {
                    t.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b border-gray-100">
                            <td class="p-3 font-bold">${escapeHtml(w.Name)}</td>
                            <td class="p-3 font-mono text-xs">${escapeHtml(w.IDType)}: ${escapeHtml(w.ID)}</td>
                            <td class="p-3 text-xs">${escapeHtml(w.Role || 'Worker')}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${w.Status.includes('Approved')?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}">${w.Status}</span></td>
                            <td class="p-3"><button class="text-blue-600 font-bold hover:underline text-xs" onclick="alert('Edit Logic Placeholder')">Edit</button></td>
                        </tr>`;
                });
            } 
        }

        // --- ADMIN FUNCTIONS ---
        async function uploadBulkUsers() {
            const file = document.getElementById('bulk-excel').files[0];
            if(!file) return alert("Please select an Excel file.");
            
            const fd = new FormData(); fd.append('excelFile', file);
            
            document.getElementById('loader').style.display = 'flex';
            const res = await fetch(API+'/admin/bulk-upload', { method: 'POST', headers: {'Authorization': `Bearer ${authToken}`}, body: fd });
            const json = await res.json();
            document.getElementById('loader').style.display = 'none';
            
            alert(json.success ? `Success! ${json.count} users processed.` : `Error: ${json.error}`);
        }

        async function resetUserPassword() {
            const email = document.getElementById('reset-email').value; 
            const pass = document.getElementById('reset-temp-pass').value;
            if(!email || !pass) return alert("Fill all fields");
            
            const res = await apiCall('/admin/reset-password', 'POST', {targetEmail: email, newTempPass: pass});
            alert(res.success ? "Password Reset Successfully. User must change on next login." : res.error);
        }

        function logout() { 
            // Optional: Call logout API
            location.reload(); 
        }
        
        // --- STATS CHART ---
        async function loadStats(data) {
            if(!data) return;
            const ctx = document.getElementById('chartStatus').getContext('2d');
            
            if(chartS) chartS.destroy();
            
            const counts = {}; 
            data.forEach(d => counts[d.Status] = (counts[d.Status]||0)+1);
            
            chartS = new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: Object.keys(counts), 
                    datasets: [{ 
                        data: Object.values(counts), 
                        backgroundColor: ['#ef4444', '#22c55e', '#64748b', '#eab308'],
                        borderWidth: 0
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } 
                } 
            });
        }

        // Initialize App
        initLogin();

    </script>
</body>
</html>
