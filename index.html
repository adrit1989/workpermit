<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Work Permit System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Poppins', 'sans-serif'] },
            colors: { glass: "rgba(255, 255, 255, 0.95)", glassDark: "rgba(15, 23, 42, 0.75)", primary: { 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' } },
            boxShadow: { 'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.37)' }
          }
        }
      }
    </script>
    <style>
      body { background: linear-gradient(135deg, #0f172a 0%, #312e81 50%, #4c1d95 100%); background-attachment: fixed; color: #1e293b; font-size: 0.85rem; }
      .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.2); padding: 1rem !important; }
      .glass-nav { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); height: 3.5rem; }
      input, select, textarea { transition: all 0.2s ease; border: 1px solid #cbd5e1; background-color: #f8fafc; padding: 0.35rem 0.5rem; font-size: 0.85rem; border-radius: 0.375rem; width: 100%; }
      input:focus, select:focus, textarea:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); background-color: #fff; outline: none; }
      input:disabled { background-color: #e2e8f0; color: #64748b; }
      label { font-size: 0.75rem; font-weight: 600; color: #4b5563; margin-bottom: 0.1rem; display: block; }
      #loader { border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid #f97316; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; position: fixed; top: 50%; left: 50%; margin: -20px 0 0 -20px; z-index: 9999; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .status-badge { padding: 0.15rem 0.5rem; border-radius: 99px; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; }
      .status-Pending, .status-Pending-Review { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
      .status-Pending-Approval { background: #fefce8; color: #a16207; border: 1px solid #fef9c3; }
      .status-Active { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
      .status-Rejected { background: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; }
      .status-Closed { background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
      #map { height: 500px; width: 100%; border-radius: 0.75rem; }
      @media print {
        @page { size: A4; margin: 5mm; }
        body { background: white !important; color: black !important; font-family: Arial, sans-serif !important; font-size: 10pt; }
        #view-login, #app-container, #loader, #toast, #view-form, #view-dashboard, #view-map-container, #kml-modal { display: none !important; }
        #print-permit-template { display: block !important; width: 100%; }
        .p-page { width: 100%; page-break-after: always; border: 1px solid #000; padding: 10px; margin-bottom: 20px; }
        .p-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 9pt; }
        .p-table td, .p-table th { border: 1px solid #000; padding: 4px; vertical-align: top; }
        .p-section-title { background: #eee !important; font-weight: bold; border: 1px solid #000; padding: 2px 5px; margin-top: 10px; }
        #watermark { display: block !important; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 80pt; color: rgba(150, 150, 150, 0.4); border: 5px solid rgba(150,150,150,0.4); padding: 20px; border-radius: 20px; }
      }
    </style>
  </head>
  <body class="antialiased min-h-screen">
    <div id="loader" style="display: none;"></div>
    
    <div id="view-login" class="flex items-center justify-center min-h-screen p-4">
      <div class="w-full max-w-sm glass-panel rounded-2xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
        <h2 class="text-2xl font-display font-bold text-gray-800 text-center mt-4 mb-6">Work Permit System</h2>
        <form id="login-form" class="space-y-4">
          <div><label>Role</label><select id="login-role" class="w-full"><option value="">Loading...</option></select></div>
          <div><label>User Name</label><select id="login-name" disabled class="w-full"><option value="">Select Role First</option></select></div>
          <div><label>Password</label><input type="password" id="login-password" class="w-full"></div>
          <button type="button" id="btn-login-submit" class="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition">Sign In</button>
        </form>
      </div>
    </div>

    <div id="app-container" style="display: none;">
      <nav class="glass-nav fixed w-full z-50 flex items-center px-4 justify-between">
        <div class="flex items-center space-x-2 text-white font-bold text-lg"><span>üõ°Ô∏è</span><span>Permit System</span></div>
        <div class="flex items-center space-x-4 text-white text-xs">
          <div class="text-right"><span id="user-info" class="block font-medium"></span><span id="user-role-badge" class="bg-white/10 px-1.5 rounded text-[10px] text-indigo-200"></span></div>
          <button id="btn-logout" class="bg-white/10 hover:bg-white/20 px-3 py-1 rounded border border-white/10">Logout</button>
        </div>
      </nav>
      
      <main class="max-w-7xl mx-auto px-2 sm:px-4 pt-20 pb-12">
        <div id="view-dashboard">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-white">Dashboard</h1>
            <div class="flex space-x-2">
              <button id="btn-view-map" class="bg-amber-500 text-white font-bold py-1.5 px-4 rounded-lg text-xs shadow hidden">Map View</button>
              <button id="btn-download-report" class="bg-indigo-500 text-white font-bold py-1.5 px-4 rounded-lg text-xs shadow hidden">Report</button>
              <button id="btn-new-permit" class="bg-emerald-500 text-white font-bold py-1.5 px-4 rounded-lg text-xs shadow hidden">+ New Permit</button>
            </div>
          </div>
          
          <div id="dashboard-charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 hidden">
            <div class="glass-panel rounded-xl"><h3 class="text-xs font-bold text-gray-700 mb-2">Distribution</h3><div class="h-48 relative"><canvas id="chartDistribution"></canvas></div></div>
            <div class="glass-panel rounded-xl"><h3 class="text-xs font-bold text-gray-700 mb-2">Volume</h3><div class="h-48 relative"><canvas id="chartTotals"></canvas></div></div>
          </div>
          
          <div class="glass-panel rounded-xl p-0!important overflow-hidden">
             <div id="dashboard-list-container" class="p-3 overflow-x-auto">
               <table class="min-w-full text-xs text-left"><thead class="bg-gray-50"><tr><th class="p-2">ID</th><th class="p-2">Work</th><th class="p-2">Vendor</th><th class="p-2">Req</th><th class="p-2">Validity</th><th class="p-2">Status</th><th class="p-2">Action</th></tr></thead><tbody id="permit-list-body" class="divide-y divide-gray-200 bg-white"></tbody></table>
               <div id="no-permits-message" class="text-center p-8 text-gray-400 hidden">No permits found.</div>
             </div>
          </div>
        </div>

        <div id="view-map-container" style="display: none; height: calc(100vh - 5rem);">
           <div class="flex justify-between items-center mb-3">
              <button id="btn-back-from-map" class="bg-white/10 text-indigo-100 px-3 py-1.5 rounded text-xs font-bold">‚Üê Back</button>
              <div class="flex gap-2">
                 <button id="btn-manage-kml" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow">Layers</button>
              </div>
           </div>
           <div class="glass-panel rounded-xl p-0 overflow-hidden flex h-[550px]">
              <div class="w-64 bg-white/90 border-r overflow-y-auto p-2">
                 <h3 class="font-bold text-indigo-800 text-xs mb-2">Active Permits</h3>
                 <div id="map-permit-list" class="space-y-2"></div>
              </div>
              <div class="flex-1 relative"><div id="map"></div></div>
           </div>
        </div>

        <div id="view-form" style="display: none;">
           <div class="flex justify-between items-center mb-3">
              <button id="btn-back-to-dashboard" class="bg-white/10 text-indigo-100 px-3 py-1.5 rounded text-xs font-bold">‚Üê Back</button>
              <div class="flex items-center space-x-3 bg-white/10 px-4 py-1 rounded"><span id="form-permit-id" class="text-lg font-bold text-white"></span><span id="form-status-badge" class="status-badge"></span></div>
           </div>
           
           <form id="permit-form" class="space-y-3">
              <input type="hidden" id="PermitID"><input type="hidden" id="Status">
              <div class="glass-panel rounded-xl">
                 <h3 class="text-sm font-bold text-indigo-700 mb-2">1. Main Details</h3>
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div><label>Type</label><select id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Height Work</option><option>Excavation Work</option><option>Vehicle Entry</option><option>Any Other</option></select></div>
                    <div><label>Requester</label><input id="RequesterName"></div>
                    <div class="col-span-2"><label>Description</label><textarea id="Desc" rows="1"></textarea></div>
                    <div class="col-span-2"><label>Location</label><input id="ExactLocation"></div>
                    <div><label>From</label><input type="datetime-local" id="ValidFrom"></div>
                    <div><label>To</label><input type="datetime-local" id="ValidTo"></div>
                    <div><label>Lat</label><input id="Latitude" placeholder="Lat"></div>
                    <div><label>Long</label><div class="flex gap-1"><input id="Longitude" placeholder="Long"><button type="button" id="btn-get-location" class="bg-indigo-600 text-white rounded px-2">üìç</button></div></div>
                    <div><label>Reviewer</label><select id="ReviewerEmail"></select></div>
                    <div><label>Approver</label><select id="ApproverEmail"></select></div>
                 </div>
              </div>

              <div id="fs-general-points" class="glass-panel rounded-xl"><h3 class="text-sm font-bold text-indigo-700 mb-2">2. Safety Checklist</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-2 form-grid"></div></div>
              
              <div id="fs-reviewer-section" class="glass-panel rounded-xl border-l-4 border-yellow-500 hidden">
                 <h3 class="text-sm font-bold text-yellow-700 mb-2">3. Reviewer Assessment</h3>
                 <div class="grid grid-cols-2 gap-2 mb-2" id="hazards-checklist"></div>
                 <div class="grid grid-cols-2 gap-2 mb-2" id="ppe-checklist"></div>
                 <textarea id="Reviewer_Remarks" placeholder="Remarks" class="w-full bg-yellow-50 border-yellow-200"></textarea>
              </div>

              <div id="fs-approver-section" class="glass-panel rounded-xl border-l-4 border-green-500 hidden">
                 <h3 class="text-sm font-bold text-green-700 mb-2">4. Final Approval</h3>
                 <textarea id="Approver_Remarks" placeholder="Remarks" class="w-full bg-green-50 border-green-200"></textarea>
              </div>

              <div id="renewals-section" class="glass-panel rounded-xl hidden">
                 <h3 class="text-sm font-bold text-gray-800">Renewals</h3>
                 <table class="w-full text-xs mt-2"><thead class="bg-gray-50"><tr><th>From</th><th>To</th><th>HC%</th><th>Status</th></tr></thead><tbody id="renewals-table-body"></tbody></table>
                 <form id="form-renewal" class="mt-2 bg-indigo-50 p-2 hidden">
                    <div class="grid grid-cols-4 gap-2">
                       <input type="datetime-local" id="RenewalValidFrom"><input type="datetime-local" id="RenewalValidTill"><input id="RenewalHC" placeholder="HC%"><input id="RenewalToxic" placeholder="Tox">
                       <input id="RenewalOxygen" placeholder="O2%"><input id="RenewalPrecautions" placeholder="Precautions" class="col-span-3">
                    </div>
                    <button type="submit" class="mt-2 bg-indigo-600 text-white px-4 py-1 rounded text-xs">Submit Renewal</button>
                 </form>
              </div>

              <div id="action-buttons-container" class="fixed bottom-0 left-0 w-full bg-white/95 p-3 shadow-xl z-40 flex justify-end gap-2 border-t"></div>
              <div class="h-16"></div>
           </form>
        </div>
      </main>
    </div>

    <div id="kml-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
       <div class="bg-white rounded-xl p-4 w-96 shadow-2xl">
          <div class="flex justify-between font-bold mb-4"><h3>Map Layers</h3><button onclick="document.getElementById('kml-modal').style.display='none'">√ó</button></div>
          <input type="file" id="kml-file-input" class="text-xs mb-2">
          <button id="btn-upload-kml" class="bg-blue-600 text-white px-4 py-1 rounded text-xs w-full mb-4">Upload KML</button>
          <ul id="kml-list" class="text-xs space-y-2 max-h-40 overflow-y-auto"></ul>
       </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-xl bg-gray-900 text-white text-xs hidden z-50"></div>
    
    <div id="print-permit-template" style="display:none;">
       <div id="watermark"></div>
       <div class="p-page">
          <div class="text-center font-bold text-xl">Indian Oil Corporation Limited</div>
          <div class="text-center text-sm mb-4">Pipeline Division - WORK PERMIT</div>
          <table class="p-table">
             <tr><td><strong>Permit ID:</strong> <span id="p-id"></span></td><td><strong>Status:</strong> <span id="p-status"></span></td></tr>
             <tr><td colspan="2"><strong>Description:</strong> <span id="p-desc"></span></td></tr>
             <tr><td><strong>Location:</strong> <span id="p-loc"></span></td><td><strong>Dept:</strong> <span id="p-dept"></span></td></tr>
             <tr><td><strong>Valid From:</strong> <span id="p-from"></span></td><td><strong>Valid To:</strong> <span id="p-to"></span></td></tr>
          </table>
          <div class="p-section-title">SIGNATURES</div>
          <table class="p-table">
             <tr><td><strong>Requester:</strong> <span id="p-req-sig"></span></td><td><strong>Reviewer:</strong> <span id="p-rev-sig"></span></td><td><strong>Approver:</strong> <span id="p-app-sig"></span></td></tr>
          </table>
       </div>
    </div>

    <script>
      const API = "/api";
      let currentUser = null, currentPermitId = null, mapInstance = null, activeKmlLayers = [];
      const generalPointsQuestions = [
        { id: "GP_Q1", text: "1. Equipment/Work Area Inspected" }, { id: "GP_Q2", text: "2. Surrounding Area Cleaned" },
        { id: "GP_Q3", text: "3. Sewer Manhole Covered" }, { id: "GP_Q12", text: "12. Gas Test (Toxic/HC/O2)", isGasTest: true }
      ];
      const hazards = [{id:"H_H2S", text:"H2S"}, {id:"H_Height", text:"Height Work"}];
      const ppe = [{id:"P_Helmet", text:"Helmet"}, {id:"P_Goggles", text:"Goggles"}];

      document.addEventListener("DOMContentLoaded", () => {
          loadUsers();
          document.getElementById("btn-login-submit").onclick = handleLogin;
          document.getElementById("btn-logout").onclick = () => location.reload();
          document.getElementById("btn-new-permit").onclick = showNewPermit;
          document.getElementById("btn-back-to-dashboard").onclick = showDashboard;
          document.getElementById("permit-form").onsubmit = handleFormSubmit;
          document.getElementById("btn-view-map").onclick = showMap;
          document.getElementById("btn-back-from-map").onclick = showDashboard;
          document.getElementById("btn-get-location").onclick = handleGetLocation;
          document.getElementById("btn-manage-kml").onclick = () => { document.getElementById("kml-modal").style.display='block'; loadKmlList(); };
          document.getElementById("btn-upload-kml").onclick = handleUploadKml;
          
          buildChecklist("#fs-general-points .form-grid", generalPointsQuestions);
          buildCheckboxGrid("hazards-checklist", hazards);
          buildCheckboxGrid("ppe-checklist", ppe);
      });

      async function apiCall(endpoint, method="GET", body=null) {
          const opts = { method, headers: {'Content-Type':'application/json'} };
          if(body) opts.body = JSON.stringify(body);
          const res = await fetch(API+endpoint, opts);
          return await res.json();
      }

      async function loadUsers() {
          const u = await apiCall('/users');
          window.users = u;
          const sel = document.getElementById("login-role");
          sel.innerHTML = '<option value="">Select Role</option><option>Requester</option><option>Reviewer</option><option>Approver</option>';
          sel.onchange = () => {
              const list = u[sel.value+'s'];
              const n = document.getElementById("login-name"); n.disabled=false; n.innerHTML="";
              list.forEach(x => n.innerHTML+=`<option value="${x.email}">${x.name}</option>`);
          }
      }

      async function handleLogin() {
          const role = document.getElementById("login-role").value;
          const name = document.getElementById("login-name").selectedOptions[0].text; // Name
          const email = document.getElementById("login-name").value; // Email
          const pass = document.getElementById("login-password").value;
          const res = await apiCall('/login', 'POST', {role, name: email, password: pass});
          if(res.success) {
              currentUser = { ...res.user, name }; // Ensure name is set for UI
              document.getElementById("view-login").style.display='none';
              document.getElementById("app-container").style.display='block';
              document.getElementById("user-info").innerText = name;
              document.getElementById("user-role-badge").innerText = role;
              updateRoleUI();
              loadDashboard();
          } else alert(res.message);
      }

      function updateRoleUI() {
          const r = currentUser.Role;
          if(r === 'Requester') document.getElementById("btn-new-permit").classList.remove('hidden');
          if(r === 'Reviewer' || r === 'Approver') {
              document.getElementById("dashboard-charts-container").classList.remove('hidden');
              document.getElementById("btn-download-report").classList.remove('hidden');
              document.getElementById("btn-view-map").classList.remove('hidden');
              loadStats();
          }
      }

      async function loadDashboard() {
          const res = await apiCall('/dashboard', 'POST', {role: currentUser.Role, email: currentUser.Email});
          const list = document.getElementById("permit-list-body"); list.innerHTML = "";
          res.forEach(p => {
              list.innerHTML += `<tr class="hover:bg-gray-50 cursor-pointer border-b" onclick="openPermit('${p.PermitID}')">
                  <td class="p-2 font-bold text-indigo-600">${p.PermitID}</td>
                  <td class="p-2">${p.WorkType}</td>
                  <td class="p-2">${p.Vendor||'-'}</td>
                  <td class="p-2">${p.RequesterName}</td>
                  <td class="p-2 text-[10px]">${p.ValidFrom.replace('T',' ')}<br>${p.ValidTo.replace('T',' ')}</td>
                  <td class="p-2"><span class="status-badge status-${p.Status.replace(/ /g,'-')}">${p.Status}</span></td>
                  <td class="p-2 text-blue-600 font-bold">Open</td>
              </tr>`;
          });
      }

      function showNewPermit() {
          document.getElementById("permit-form").reset();
          currentPermitId = null;
          document.getElementById("PermitID").value = "";
          document.getElementById("Status").value = "New";
          document.getElementById("RequesterName").value = currentUser.name;
          const revS=document.getElementById("ReviewerEmail"), appS=document.getElementById("ApproverEmail");
          revS.innerHTML=""; appS.innerHTML="";
          window.users.Reviewers.forEach(u=>revS.innerHTML+=`<option value="${u.email}">${u.name}</option>`);
          window.users.Approvers.forEach(u=>appS.innerHTML+=`<option value="${u.email}">${u.name}</option>`);
          showForm();
      }

      async function handleFormSubmit(e) {
          e.preventDefault();
          const fd = new FormData(document.getElementById("permit-form"));
          // Manual Checkbox handling
          document.querySelectorAll('input[type="checkbox"]').forEach(c => fd.set(c.name, c.checked ? "Y" : "N"));
          
          if(document.getElementById("Status").value === "New") {
              fd.append("RequesterEmail", currentUser.Email);
              const res = await fetch(API+'/save-permit', {method:'POST', body:fd});
              const json = await res.json();
              if(json.success) { showDashboard(); } else alert(json.error);
          }
      }

      async function openPermit(id) {
          const p = await apiCall('/permit-data', 'POST', {permitId: id});
          currentPermitId = id;
          // Populate Form
          Object.keys(p).forEach(k => {
              const el = document.getElementById(k);
              if(el) {
                  if(el.type==='checkbox') el.checked = p[k]==='Y';
                  else el.value = p[k];
              }
          });
          document.getElementById("form-permit-id").innerText = p.PermitID;
          document.getElementById("form-status-badge").innerText = p.Status;
          document.getElementById("form-status-badge").className = `status-badge status-${p.Status.replace(/ /g,'-')}`;
          
          // Logic for buttons/sections based on Status & Role (Simplified)
          updateFormView(p.Status);
          showForm();
      }

      function updateFormView(status) {
          const btns = document.getElementById("action-buttons-container"); btns.innerHTML="";
          const r = currentUser.Role;
          document.getElementById("fs-reviewer-section").classList.add('hidden');
          document.getElementById("fs-approver-section").classList.add('hidden');
          
          if(status === 'Pending Review' && r === 'Reviewer') {
              document.getElementById("fs-reviewer-section").classList.remove('hidden');
              btns.innerHTML = `<button onclick="updateStatus('reject')" class="bg-red-500 text-white px-4 py-1 rounded">Reject</button>
                                <button onclick="updateStatus('review')" class="bg-emerald-600 text-white px-4 py-1 rounded">Submit Review</button>`;
          }
          if(status === 'Pending Approval' && r === 'Approver') {
              document.getElementById("fs-reviewer-section").classList.remove('hidden');
              document.getElementById("fs-approver-section").classList.remove('hidden');
              btns.innerHTML = `<button onclick="updateStatus('reject')" class="bg-red-500 text-white px-4 py-1 rounded">Reject</button>
                                <button onclick="updateStatus('approve')" class="bg-emerald-600 text-white px-4 py-1 rounded">Approve</button>`;
          }
      }

      async function updateStatus(action) {
          const comment = currentUser.Role === 'Reviewer' ? document.getElementById("Reviewer_Remarks").value : document.getElementById("Approver_Remarks").value;
          const body = { PermitID: currentPermitId, action, role: currentUser.Role, user: currentUser.name, comment };
          const res = await apiCall('/update-status', 'POST', body);
          if(res.success) showDashboard(); else alert(res.error);
      }

      function handleGetLocation() {
          if(!navigator.geolocation) return alert("No Geo");
          navigator.geolocation.getCurrentPosition(p => {
              document.getElementById("Latitude").value = p.coords.latitude;
              document.getElementById("Longitude").value = p.coords.longitude;
          });
      }

      function showMap() {
          document.getElementById("view-dashboard").style.display='none';
          document.getElementById("view-map-container").style.display='block';
          if(!mapInstance) {
              mapInstance = new google.maps.Map(document.getElementById("map"), {center: {lat:26.11, lng:85.39}, zoom:12});
          }
          loadMapData();
      }

      async function loadMapData() {
          const points = await apiCall('/map-data', 'POST');
          const list = document.getElementById("map-permit-list"); list.innerHTML="";
          points.forEach(pt => {
              new google.maps.Marker({ position: {lat: pt.lat, lng: pt.lng}, map: mapInstance, title: pt.PermitID });
              list.innerHTML += `<div class="bg-indigo-50 p-2 rounded text-xs mb-1 cursor-pointer" onclick="mapInstance.panTo({lat:${pt.lat}, lng:${pt.lng}})"><b>${pt.PermitID}</b><br>${pt.WorkType}</div>`;
          });
      }

      async function loadKmlList() {
          const files = await apiCall('/kml');
          const ul = document.getElementById("kml-list"); ul.innerHTML="";
          files.forEach(f => {
              ul.innerHTML += `<li class="flex justify-between">${f.name} <button class="text-red-500" onclick="deleteKml('${f.name}')">Del</button></li>`;
              // Add to map
              new google.maps.KmlLayer({url: f.url, map: mapInstance});
          });
      }

      async function handleUploadKml() {
          const input = document.getElementById("kml-file-input");
          const fd = new FormData();
          fd.append("file", input.files[0]);
          await fetch(API+'/kml', {method:'POST', body:fd});
          loadKmlList();
      }

      async function deleteKml(name) {
          await fetch(API+'/kml/'+name, {method:'DELETE'});
          loadKmlList();
      }

      async function loadStats() {
          const res = await apiCall('/stats', 'POST');
          const ctxD = document.getElementById('chartDistribution').getContext('2d');
          new Chart(ctxD, {type: 'doughnut', data: {labels: Object.keys(res.stats.counts), datasets: [{data: Object.values(res.stats.counts), backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b']}]}});
      }

      // Utils
      function showForm() { document.getElementById("view-dashboard").style.display='none'; document.getElementById("view-form").style.display='block'; }
      function showDashboard() { document.getElementById("view-dashboard").style.display='block'; document.getElementById("view-form").style.display='none'; document.getElementById("view-map-container").style.display='none'; loadDashboard(); }
      function buildChecklist(sel, items) { document.querySelector(sel).innerHTML = items.map(q => `<div class="border p-2 rounded"><label>${q.text}</label><div class="flex gap-2"><label><input type="radio" name="${q.id}" value="Yes"> Yes</label><label><input type="radio" name="${q.id}" value="NA"> NA</label></div>${q.isGasTest?`<div class="grid grid-cols-3 gap-1 mt-1"><input name="${q.id}_Toxic" placeholder="Tox"><input name="${q.id}_HC" placeholder="HC"><input name="${q.id}_O2" placeholder="O2"></div>`:''}</div>`).join(''); }
      function buildCheckboxGrid(id, items) { document.getElementById(id).innerHTML = items.map(i => `<label class="flex items-center gap-1 border p-1 rounded"><input type="checkbox" name="${i.id}" value="Y"> ${i.text}</label>`).join(''); }
    </script>
  </body>
</html>
