<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Work Permit System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU"></script>
    <style>
      body { background: linear-gradient(135deg, #0f172a 0%, #312e81 50%, #4c1d95 100%); color: #1e293b; font-family: sans-serif; font-size: 0.85rem; }
      .glass-panel { background: rgba(255,255,255,0.9); padding: 1rem; border-radius: 0.5rem; }
      input, select, textarea { width: 100%; border: 1px solid #ccc; padding: 4px; border-radius: 4px; }
      .status-badge { padding: 2px 8px; border-radius: 99px; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; }
      #map { height: 500px; width: 100%; border-radius: 0.5rem; }
    </style>
  </head>
  <body>
    <div id="loader" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); color:white; display:flex; align-items:center; justify-content:center; z-index:50;">Processing...</div>

    <div id="view-login" class="flex items-center justify-center min-h-screen">
      <div class="glass-panel w-96">
        <h2 class="text-2xl font-bold text-center mb-4">Permit System</h2>
        <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-3">
          <select id="login-role"><option>Loading...</option></select>
          <select id="login-name" disabled><option>Select Role</option></select>
          <input type="password" id="login-password" placeholder="Password">
          <button class="w-full bg-blue-600 text-white py-2 rounded">Sign In</button>
        </form>
      </div>
    </div>

    <div id="app-container" style="display:none;">
      <nav class="bg-gray-900 text-white p-3 flex justify-between items-center fixed w-full z-40">
        <div class="font-bold">üõ°Ô∏è Permit System</div>
        <div class="flex gap-4 items-center">
           <span id="user-info" class="text-xs"></span>
           <button onclick="location.reload()" class="bg-gray-700 px-3 py-1 rounded text-xs">Logout</button>
        </div>
      </nav>

      <main class="pt-16 px-4 pb-12 max-w-7xl mx-auto">
        <div id="view-dashboard">
           <div class="flex justify-between mb-4">
              <h1 class="text-xl font-bold text-white">Dashboard</h1>
              <div class="flex gap-2">
                 <button id="btn-view-map" onclick="showMap()" class="bg-amber-500 text-white px-3 py-1 rounded hidden">Map</button>
                 <button id="btn-new-permit" onclick="showNewPermit()" class="bg-green-600 text-white px-3 py-1 rounded hidden">+ New Permit</button>
              </div>
           </div>
           <div class="glass-panel overflow-x-auto">
              <table class="w-full text-xs text-left"><thead class="bg-gray-100"><tr><th class="p-2">ID</th><th>Work</th><th>Requester</th><th>Status</th><th>Action</th></tr></thead><tbody id="permit-list-body"></tbody></table>
           </div>
        </div>

        <div id="view-map-container" style="display:none;">
           <button onclick="showDashboard()" class="bg-white px-3 py-1 rounded mb-2">Back</button>
           <div id="map"></div>
        </div>

        <div id="view-form" style="display:none;">
           <button onclick="showDashboard()" class="bg-white/20 text-white px-3 py-1 rounded mb-3">‚Üê Back</button>
           <form id="permit-form" class="space-y-3">
              <input type="hidden" id="PermitID"><input type="hidden" id="Status">
              
              <div class="glass-panel">
                 <h3 class="font-bold text-blue-700 mb-2">1. Main Details</h3>
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                    <div><label>Type</label><select id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Height Work</option><option>Excavation</option><option>Other</option></select></div>
                    <div><label>Requester</label><input id="RequesterName"></div>
                    <div><label>Applicant</label><input id="OfficialName"></div>
                    <div class="col-span-2"><label>Description</label><input id="Desc"></div>
                    <div class="col-span-2"><label>Exact Location</label><input id="ExactLocation"></div>
                    <div><label>Unit</label><input id="LocationUnit" value="Pipeline"></div>
                    <div><label>Dept</label><input id="IssuedToDept"></div>
                    <div><label>Vendor</label><input id="Vendor"></div>
                    
                    <div><label>Loc Permit #</label><input id="LocationPermitSno"></div>
                    <div><label>Isolation Cert</label><input id="RefIsolationCert"></div>
                    <div><label>Cross Ref</label><input id="CrossRefPermits"></div>
                    <div><label>JSA Ref</label><input id="JsaRef"></div>
                    <div><label>MOC Req</label><select id="MocRequired"><option>No</option><option>Yes</option></select></div>
                    <div><label>MOC Ref</label><input id="MocRef"></div>
                    <div><label>CCTV</label><select id="CctvAvailable"><option>No</option><option>Yes</option></select></div>
                    <div><label>CCTV Detail</label><input id="CctvDetail"></div>

                    <div><label>Valid From</label><input type="datetime-local" id="ValidFrom"></div>
                    <div><label>Valid To</label><input type="datetime-local" id="ValidTo"></div>
                    <div><label>Lat</label><input id="Latitude"></div>
                    <div><label>Long</label><div class="flex gap-1"><input id="Longitude"><button type="button" onclick="getGeo()" class="bg-blue-600 text-white px-2">üìç</button></div></div>
                    
                    <div><label>Reviewer</label><select id="ReviewerEmail"></select></div>
                    <div><label>Approver</label><select id="ApproverEmail"></select></div>
                 </div>
              </div>

              <div class="glass-panel">
                 <h3 class="font-bold text-blue-700 mb-2">2. Checklists</h3>
                 <div class="grid grid-cols-2 gap-2 text-xs" id="checklist-container"></div>
                 <div class="grid grid-cols-4 gap-2 mt-2 text-xs" id="hazards-container"></div>
                 <div class="grid grid-cols-4 gap-2 mt-2 text-xs" id="ppe-container"></div>
              </div>

              <div id="fs-reviewer-section" class="glass-panel hidden">
                 <h3 class="font-bold text-yellow-700 mb-2">3. Reviewer</h3>
                 <textarea id="Reviewer_Remarks" placeholder="Remarks" class="bg-yellow-50"></textarea>
              </div>

              <div id="fs-approver-section" class="glass-panel hidden">
                 <h3 class="font-bold text-green-700 mb-2">4. Approval</h3>
                 <select id="ForceBackgroundColor" class="mb-1"><option value="">Auto Color</option><option value="Red">Red</option><option value="Green">Green</option></select>
                 <textarea id="Approver_Remarks" placeholder="Remarks" class="bg-green-50"></textarea>
              </div>

              <div id="action-buttons" class="fixed bottom-0 left-0 w-full bg-white p-3 shadow-xl flex justify-end gap-2"></div>
              <div class="h-16"></div>
           </form>
        </div>
      </main>
    </div>

    <script>
      const API = "/api";
      let currentUser = null, currentPermitId = null;
      
      const questions = [
          {id:"GP_Q1", text:"Equipment Inspected"}, {id:"GP_Q2", text:"Area Cleaned"}, {id:"GP_Q3", text:"Sewers Covered"}, 
          {id:"GP_Q4", text:"Hazards Considered"}, {id:"GP_Q5", text:"Blinded"}, {id:"GP_Q6", text:"Depressurized"}, 
          {id:"GP_Q12", text:"Gas Test", isGas:true}, {id:"HW_Q1", text:"Ventilation"}, {id:"HW_Q2", text:"Exit Means"}
      ];
      const hazards = ["H_H2S", "H_LackOxygen", "H_Corrosive", "H_ToxicGas", "H_Combustible", "H_Height", "H_HighNoise"];
      const ppe = ["P_FaceShield", "P_FreshAirMask", "P_CompressedBA", "P_Goggles", "P_SafetyHarness"];

      document.addEventListener("DOMContentLoaded", () => {
          loadUsers();
          buildChecklist();
      });

      async function apiCall(endpoint, method="GET", body=null) {
          const opts = { method, headers: {'Content-Type':'application/json'} };
          if(body) opts.body = JSON.stringify(body);
          const res = await fetch(API+endpoint, opts);
          return await res.json();
      }

      async function loadUsers() {
          const u = await apiCall('/users');
          window.users = u;
          const sel = document.getElementById("login-role");
          sel.innerHTML = '<option value="">Select Role</option><option>Requester</option><option>Reviewer</option><option>Approver</option>';
          sel.onchange = () => {
              const list = u[sel.value+'s'];
              const n = document.getElementById("login-name"); n.disabled=false; n.innerHTML="";
              list.forEach(x => n.innerHTML+=`<option value="${x.email}">${x.name}</option>`);
          }
      }

      async function handleLogin() {
          const role = document.getElementById("login-role").value;
          const name = document.getElementById("login-name").selectedOptions[0].text;
          const email = document.getElementById("login-name").value;
          const pass = document.getElementById("login-password").value;
          const res = await apiCall('/login', 'POST', {role, name: email, password: pass});
          if(res.success) {
              currentUser = { ...res.user, name };
              document.getElementById("view-login").style.display='none';
              document.getElementById("app-container").style.display='block';
              document.getElementById("user-info").innerText = `${name} (${role})`;
              updateRoleUI();
              loadDashboard();
          } else alert(res.message);
      }

      function updateRoleUI() {
          const r = currentUser.Role;
          if(r === 'Requester') document.getElementById("btn-new-permit").classList.remove('hidden');
          if(r === 'Reviewer' || r === 'Approver') document.getElementById("btn-view-map").classList.remove('hidden');
      }

      async function loadDashboard() {
          const res = await apiCall('/dashboard', 'POST', {role: currentUser.Role, email: currentUser.Email});
          const list = document.getElementById("permit-list-body"); list.innerHTML = "";
          res.forEach(p => {
              list.innerHTML += `<tr class="hover:bg-gray-200 cursor-pointer border-b" onclick="openPermit('${p.PermitID}')">
                  <td class="p-2 font-bold text-blue-600">${p.PermitID}</td>
                  <td class="p-2">${p.WorkType}</td>
                  <td class="p-2">${p.RequesterName}</td>
                  <td class="p-2"><span class="bg-blue-100 text-blue-800 px-2 rounded">${p.Status}</span></td>
                  <td class="p-2">Open</td>
              </tr>`;
          });
      }

      function showNewPermit() {
          document.getElementById("permit-form").reset();
          currentPermitId = null;
          document.getElementById("PermitID").value = "";
          document.getElementById("Status").value = "New";
          document.getElementById("RequesterName").value = currentUser.name;
          document.getElementById("OfficialName").value = currentUser.name;
          
          const revS=document.getElementById("ReviewerEmail"), appS=document.getElementById("ApproverEmail");
          revS.innerHTML=""; appS.innerHTML="";
          window.users.Reviewers.forEach(u=>revS.innerHTML+=`<option value="${u.email}">${u.name}</option>`);
          window.users.Approvers.forEach(u=>appS.innerHTML+=`<option value="${u.email}">${u.name}</option>`);
          
          document.getElementById("action-buttons").innerHTML = `<button type="button" onclick="submitNewPermit()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold shadow">Submit Permit</button>`;
          showForm();
      }

      async function submitNewPermit() {
          const fd = new FormData(document.getElementById("permit-form"));
          document.querySelectorAll('input[type="checkbox"]').forEach(c => fd.set(c.name, c.checked ? "Y" : "N"));
          fd.append("RequesterEmail", currentUser.Email);
          
          const res = await fetch(API+'/save-permit', {method:'POST', body:fd});
          const json = await res.json();
          if(json.success) { alert("Created: " + json.permitId); showDashboard(); } else alert(json.error);
      }

      async function openPermit(id) {
          const p = await apiCall('/permit-data', 'POST', {permitId: id});
          currentPermitId = id;
          Object.keys(p).forEach(k => {
              const el = document.getElementById(k);
              if(el) { if(el.type==='checkbox') el.checked = p[k]==='Y'; else el.value = p[k]; }
          });
          updateFormView(p.Status);
          showForm();
      }

      function updateFormView(status) {
          const btns = document.getElementById("action-buttons"); btns.innerHTML="";
          const r = currentUser.Role;
          document.getElementById("fs-reviewer-section").classList.add('hidden');
          document.getElementById("fs-approver-section").classList.add('hidden');
          
          if(status === 'Pending Review' && r === 'Reviewer') {
              document.getElementById("fs-reviewer-section").classList.remove('hidden');
              btns.innerHTML = `<button onclick="updateStatus('reject')" class="bg-red-500 text-white px-4 py-2 rounded">Reject</button>
                                <button onclick="updateStatus('review')" class="bg-green-600 text-white px-4 py-2 rounded">Submit Review</button>`;
          }
          if(status === 'Pending Approval' && r === 'Approver') {
              document.getElementById("fs-reviewer-section").classList.remove('hidden');
              document.getElementById("fs-approver-section").classList.remove('hidden');
              btns.innerHTML = `<button onclick="updateStatus('reject')" class="bg-red-500 text-white px-4 py-2 rounded">Reject</button>
                                <button onclick="updateStatus('approve')" class="bg-green-600 text-white px-4 py-2 rounded">Approve</button>`;
          }
          if(status === 'Active') {
              btns.innerHTML = `<a href="${API}/download-pdf/${currentPermitId}" target="_blank" class="bg-gray-800 text-white px-4 py-2 rounded">Download PDF</a>`;
          }
      }

      async function updateStatus(action) {
          const comment = currentUser.Role === 'Reviewer' ? document.getElementById("Reviewer_Remarks").value : document.getElementById("Approver_Remarks").value;
          const body = { PermitID: currentPermitId, action, role: currentUser.Role, user: currentUser.name, comment, ForceBackgroundColor: document.getElementById("ForceBackgroundColor").value };
          const res = await apiCall('/update-status', 'POST', body);
          if(res.success) showDashboard(); else alert(res.error);
      }

      function getGeo() {
          if(!navigator.geolocation) return alert("No Geo");
          navigator.geolocation.getCurrentPosition(p => {
              document.getElementById("Latitude").value = p.coords.latitude;
              document.getElementById("Longitude").value = p.coords.longitude;
          });
      }

      function buildChecklist() {
          document.getElementById("checklist-container").innerHTML = questions.map(q => q.isGas ? 
             `<div class="border p-2 rounded col-span-2 bg-gray-50"><label class="font-bold">${q.text}</label><div class="flex gap-2 mt-1"><input name="${q.id}_Toxic" placeholder="Toxic"><input name="${q.id}_HC" placeholder="HC"><input name="${q.id}_O2" placeholder="O2"></div></div>` :
             `<div class="border p-2 rounded bg-gray-50 flex justify-between items-center"><label>${q.text}</label><div class="flex gap-2"><label><input type="radio" name="${q.id}" value="Yes"> Yes</label><label><input type="radio" name="${q.id}" value="NA"> NA</label></div></div>`
          ).join('');
          
          document.getElementById("hazards-container").innerHTML = hazards.map(h => `<label class="flex items-center gap-1 border p-1 rounded"><input type="checkbox" name="${h}" value="Y"> ${h.replace('H_','')}</label>`).join('');
          document.getElementById("ppe-container").innerHTML = ppe.map(p => `<label class="flex items-center gap-1 border p-1 rounded"><input type="checkbox" name="${p}" value="Y"> ${p.replace('P_','')}</label>`).join('');
      }

      function showForm() { document.getElementById("view-dashboard").style.display='none'; document.getElementById("view-form").style.display='block'; }
      function showDashboard() { document.getElementById("view-dashboard").style.display='block'; document.getElementById("view-form").style.display='none'; document.getElementById("view-map-container").style.display='none'; loadDashboard(); }
      function showMap() { document.getElementById("view-dashboard").style.display='none'; document.getElementById("view-map-container").style.display='block'; /* Init map logic here if needed */ }
    </script>
  </body>
</html>
